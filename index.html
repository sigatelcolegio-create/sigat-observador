<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0d1b3e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Observador">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>SIGAT Â· Observador Digital</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGAT OBSERVADOR DIGITAL â€” PWA
   Estilo: Institucional moderno, alto contraste, mobile-first
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
  --bg: #f0f2f5;
  --surface: #ffffff;
  --primary: #0d1b3e;
  --primary-light: #1a3068;
  --accent: #2d6cdf;
  --accent-light: #e8f0fe;
  --success: #1a8a4a;
  --success-bg: #e6f7ed;
  --warning: #c47a10;
  --warning-bg: #fff6e5;
  --danger: #c62828;
  --danger-bg: #fce8e8;
  --text: #1a1a2e;
  --text-secondary: #5f6b7a;
  --border: #d8dde4;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', monospace;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; height: 100%; -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  height: 100%;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€ APP SHELL â”€â”€â”€â”€ */
#app {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.screen {
  display: none;
  flex-direction: column;
  height: 100%;
  opacity: 0;
  transition: opacity 0.2s ease;
}
.screen.active {
  display: flex;
  opacity: 1;
}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€ */
.header {
  background: var(--primary);
  color: white;
  padding: calc(var(--safe-top) + 12px) 16px 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.header h1 {
  font-size: 1.1rem;
  font-weight: 600;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.header-sub {
  font-size: 0.75rem;
  opacity: 0.7;
  font-weight: 400;
}
.btn-back {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 1.2rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.btn-back:active { background: rgba(255,255,255,0.2); }

/* â”€â”€â”€ CONNECTION BADGE â”€â”€â”€â”€ */
.conn-badge {
  position: fixed;
  top: calc(var(--safe-top) + 8px);
  right: 12px;
  z-index: 100;
  font-size: 0.65rem;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 20px;
  letter-spacing: 0.3px;
  text-transform: uppercase;
  pointer-events: none;
  transition: all 0.3s ease;
}
.conn-badge.online { background: var(--success-bg); color: var(--success); }
.conn-badge.offline { background: var(--danger-bg); color: var(--danger); }

/* â”€â”€â”€ SYNC BAR â”€â”€â”€â”€ */
.sync-bar {
  background: var(--warning-bg);
  color: var(--warning);
  font-size: 0.8rem;
  font-weight: 500;
  padding: 8px 16px;
  display: none;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  cursor: pointer;
}
.sync-bar.visible { display: flex; }
.sync-bar .sync-spinner {
  width: 14px; height: 14px;
  border: 2px solid var(--warning);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ SCROLL AREA â”€â”€â”€â”€ */
.scroll-area {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
  padding-bottom: calc(var(--safe-bottom) + 24px);
}

/* â”€â”€â”€ CARDS â”€â”€â”€â”€ */
.card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}
.card-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

/* â”€â”€â”€ BUTTONS â”€â”€â”€â”€ */
.btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 14px 20px;
  border: none;
  border-radius: var(--radius);
  font-family: var(--font);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.btn:active { transform: scale(0.98); }
.btn:disabled { opacity: 0.5; pointer-events: none; }

.btn-primary { background: var(--accent); color: white; }
.btn-primary:active { background: #2358b8; }

.btn-large {
  background: var(--surface);
  border: 1.5px solid var(--border);
  color: var(--text);
  padding: 18px 20px;
  border-radius: var(--radius);
  font-size: 1rem;
  text-align: left;
  justify-content: flex-start;
  margin-bottom: 10px;
}
.btn-large:active { background: var(--accent-light); border-color: var(--accent); }
.btn-large .btn-icon {
  width: 40px; height: 40px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
}
.btn-large .btn-label { font-weight: 600; }
.btn-large .btn-desc { font-size: 0.8rem; color: var(--text-secondary); font-weight: 400; margin-top: 2px; }

.btn-danger { background: var(--danger); color: white; }
.btn-outline {
  background: transparent;
  border: 1.5px solid var(--border);
  color: var(--text);
}

/* â”€â”€â”€ FORMS â”€â”€â”€â”€ */
.form-group { margin-bottom: 14px; }
.form-label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
}
.form-label.required::after { content: ' *'; color: var(--danger); }

input[type="text"], input[type="password"], input[type="date"], input[type="time"],
select, textarea {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 1rem;
  color: var(--text);
  background: var(--surface);
  transition: border-color 0.15s;
  -webkit-appearance: none;
  appearance: none;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(45,108,223,0.12);
}
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' fill='none' stroke='%235f6b7a' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 36px;
}
textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

/* â”€â”€â”€ SEARCH â”€â”€â”€â”€ */
.search-box {
  position: relative;
  margin-bottom: 14px;
}
.search-box input {
  padding-left: 40px;
}
.search-box::before {
  content: 'ğŸ”';
  position: absolute;
  left: 13px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.9rem;
}

/* â”€â”€â”€ RADIO PILLS â”€â”€â”€â”€ */
.radio-pills {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.radio-pill {
  flex: 1;
  min-width: 0;
}
.radio-pill input { display: none; }
.radio-pill label {
  display: block;
  text-align: center;
  padding: 10px 8px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.radio-pill input:checked + label {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}
.radio-pill input:checked + label.pill-grave {
  background: var(--warning);
  border-color: var(--warning);
}
.radio-pill input:checked + label.pill-gravisima {
  background: var(--danger);
  border-color: var(--danger);
}

/* â”€â”€â”€ STUDENT LIST ITEMS â”€â”€â”€â”€ */
.student-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px;
  background: var(--surface);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  cursor: pointer;
  border: 1.5px solid transparent;
  transition: border-color 0.15s;
}
.student-item:active { border-color: var(--accent); background: var(--accent-light); }
.student-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700;
  font-size: 0.85rem;
  flex-shrink: 0;
}
.student-name { font-weight: 600; font-size: 0.95rem; }
.student-meta { font-size: 0.78rem; color: var(--text-secondary); margin-top: 2px; }

/* â”€â”€â”€ OBSERVATION HISTORY ITEM â”€â”€â”€â”€ */
.obs-item {
  padding: 14px;
  background: var(--surface);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  border-left: 4px solid var(--border);
}
.obs-item.tipo-i { border-left-color: var(--accent); }
.obs-item.tipo-ii { border-left-color: var(--warning); }
.obs-item.tipo-iii { border-left-color: var(--danger); }
.obs-item.pendiente { border-left-color: #9e9e9e; border-left-style: dashed; }
.obs-date { font-size: 0.75rem; color: var(--text-secondary); font-family: var(--mono); }
.obs-type {
  display: inline-block;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 2px 7px;
  border-radius: 4px;
  margin: 4px 4px 4px 0;
  text-transform: uppercase;
}
.obs-type.tipo-i { background: var(--accent-light); color: var(--accent); }
.obs-type.tipo-ii { background: var(--warning-bg); color: var(--warning); }
.obs-type.tipo-iii { background: var(--danger-bg); color: var(--danger); }
.obs-cat { background: #f0f2f5; color: var(--text-secondary); }
.obs-desc { font-size: 0.88rem; margin-top: 6px; line-height: 1.45; }
.obs-teacher { font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px; }
.obs-pending-badge {
  font-size: 0.7rem;
  background: #e0e0e0;
  color: #666;
  padding: 2px 7px;
  border-radius: 4px;
  font-weight: 600;
}

/* â”€â”€â”€ BEHAVIOR SCORE â”€â”€â”€â”€ */
.score-display {
  text-align: center;
  padding: 16px;
}
.score-number {
  font-size: 2.5rem;
  font-weight: 700;
  font-family: var(--mono);
  line-height: 1;
}
.score-number.superior { color: var(--success); }
.score-number.alto { color: var(--accent); }
.score-number.basico { color: var(--warning); }
.score-number.bajo { color: var(--danger); }
.score-label {
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 4px;
}

/* â”€â”€â”€ TOAST NOTIFICATION â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: calc(var(--safe-bottom) + 20px);
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--primary);
  color: white;
  padding: 12px 24px;
  border-radius: 30px;
  font-size: 0.88rem;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  z-index: 200;
  transition: transform 0.3s ease;
  white-space: nowrap;
  max-width: 90%;
  text-align: center;
}
.toast.visible { transform: translateX(-50%) translateY(0); }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }

/* â”€â”€â”€ LOADING OVERLAY â”€â”€â”€â”€ */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.92);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 150;
  gap: 16px;
}
.loading-overlay.visible { display: flex; }
.loading-spinner {
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
.loading-text { font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }

/* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€â”€ */
.login-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100%;
  padding: 32px 24px;
}
.login-logo {
  font-size: 2.8rem;
  margin-bottom: 8px;
}
.login-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
  text-align: center;
}
.login-subtitle {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-top: 4px;
  margin-bottom: 28px;
  text-align: center;
}
.login-form { width: 100%; max-width: 360px; }
.login-error {
  background: var(--danger-bg);
  color: var(--danger);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  margin-bottom: 14px;
  display: none;
}
.login-error.visible { display: block; }
.login-footer {
  margin-top: 24px;
  font-size: 0.75rem;
  color: var(--text-secondary);
  text-align: center;
}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€ */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}
.empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
.empty-state .empty-text { font-size: 0.9rem; }

/* â”€â”€â”€ CONFIRMATION MODAL â”€â”€â”€â”€ */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: flex-end;
  justify-content: center;
  z-index: 160;
  padding: 16px;
}
.modal-backdrop.visible { display: flex; }
.modal-sheet {
  background: var(--surface);
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 24px;
  width: 100%;
  max-width: 420px;
  max-height: 80vh;
  overflow-y: auto;
}
.modal-sheet h3 { font-size: 1.1rem; margin-bottom: 12px; }
.modal-sheet p { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 20px; }
.modal-buttons { display: flex; gap: 10px; }
.modal-buttons .btn { flex: 1; }

/* â”€â”€â”€ UTILITY â”€â”€â”€â”€ */
.mt-8 { margin-top: 8px; }
.mt-16 { margin-top: 16px; }
.mb-8 { margin-bottom: 8px; }
.gap-8 { gap: 8px; }
.text-center { text-align: center; }
.text-sm { font-size: 0.8rem; }
.text-secondary { color: var(--text-secondary); }
.flex-row { display: flex; align-items: center; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="app">
  <!-- â•â•â•â•â•â•â•â•â•â•â• CONNECTION BADGE â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="connBadge" class="conn-badge online">â— En lÃ­nea</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• LOADING OVERLAY â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">Cargando...</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="toast" class="toast"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• CONFIRMATION MODAL â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal-sheet">
      <h3 id="modalTitle"></h3>
      <p id="modalBody"></p>
      <div class="modal-buttons">
        <button class="btn btn-outline" onclick="cerrarModal()">Cancelar</button>
        <button class="btn btn-primary" id="modalConfirmBtn" onclick="">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 1: LOGIN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screenLogin" class="screen active">
    <div class="login-container">
      <div class="login-logo">ğŸ«</div>
      <div class="login-title">Observador Digital</div>
      <div class="login-subtitle">IED El Triunfo â€” SIGAT</div>

      <div class="login-form">
        <div id="loginError" class="login-error"></div>

        <div class="form-group">
          <label class="form-label" for="loginUser">CÃ©dula o correo</label>
          <input type="text" id="loginUser" placeholder="Ej: 1234567890" autocomplete="username" inputmode="numeric">
        </div>

        <div class="form-group">
          <label class="form-label" for="loginPass">ContraseÃ±a</label>
          <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>

        <button class="btn btn-primary mt-8" id="btnLogin" onclick="intentarLogin()">
          Ingresar
        </button>
      </div>

      <div class="login-footer">
        ContraseÃ±a por defecto: nÃºmero de cÃ©dula
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 2: DASHBOARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screenDashboard" class="screen">
    <div class="header">
      <div style="flex:1">
        <h1 id="dashGreeting">Observador Digital</h1>
        <div class="header-sub" id="dashSubtitle"></div>
      </div>
      <button class="btn-back" onclick="mostrarMenuConfig()" title="Opciones" style="font-size:1.4rem">âš™</button>
    </div>

    <div id="syncBar" class="sync-bar" onclick="sincronizarAhora()">
      <span>ğŸ”¶</span>
      <span id="syncBarText">2 observaciones pendientes â€” Toca para sincronizar</span>
    </div>

    <div class="scroll-area">
      <button class="btn-large" onclick="irANuevaObservacion()">
        <div class="btn-icon" style="background:var(--accent-light);color:var(--accent)">âœï¸</div>
        <div>
          <div class="btn-label">Nueva observaciÃ³n</div>
          <div class="btn-desc">Registrar falta o situaciÃ³n</div>
        </div>
      </button>

      <button class="btn-large" onclick="irAHistorial()">
        <div class="btn-icon" style="background:#f0f2f5;color:var(--text)">ğŸ“‹</div>
        <div>
          <div class="btn-label">Historial</div>
          <div class="btn-desc">Buscar por estudiante</div>
        </div>
      </button>

      <button class="btn-large" onclick="sincronizarAhora()">
        <div class="btn-icon" style="background:var(--success-bg);color:var(--success)">ğŸ”„</div>
        <div>
          <div class="btn-label">Sincronizar</div>
          <div class="btn-desc" id="dashSyncStatus">Todo al dÃ­a</div>
        </div>
      </button>

      <div class="card mt-16">
        <div class="card-title">Resumen de hoy</div>
        <div class="flex-between">
          <div>
            <div style="font-size:1.8rem;font-weight:700;font-family:var(--mono)" id="dashTodayCount">0</div>
            <div class="text-sm text-secondary">Registradas hoy</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:1.8rem;font-weight:700;font-family:var(--mono)" id="dashPendingCount">0</div>
            <div class="text-sm text-secondary">Pendientes sync</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Ãšltima sincronizaciÃ³n</div>
        <div class="text-sm" id="dashLastSync">Nunca</div>
      </div>

      <button class="btn btn-outline mt-16" onclick="cerrarSesion()" style="color:var(--danger);border-color:var(--danger)">
        Cerrar sesiÃ³n
      </button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 3: SELECCIONAR ESTUDIANTE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screenSelectStudent" class="screen">
    <div class="header">
      <button class="btn-back" onclick="irADashboard()">â†</button>
      <h1 id="selectStudentTitle">Seleccionar estudiante</h1>
    </div>

    <div class="scroll-area">
      <!-- Filtros cascada -->
      <div class="card">
        <div class="form-group">
          <label class="form-label">Sede</label>
          <select id="filtroSede" onchange="actualizarFiltrosEstudiantes()">
            <option value="">â€” Todas â€”</option>
          </select>
        </div>
        <div class="flex-row gap-8">
          <div class="form-group" style="flex:1">
            <label class="form-label">Grado</label>
            <select id="filtroGrado" onchange="actualizarFiltrosEstudiantes()">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">Grupo</label>
            <select id="filtroGrupo" onchange="actualizarFiltrosEstudiantes()">
              <option value="">Todos</option>
            </select>
          </div>
        </div>
      </div>

      <!-- BÃºsqueda -->
      <div class="search-box">
        <input type="text" id="buscarEstudiante" placeholder="Buscar por nombre o documento..." oninput="filtrarEstudiantes()">
      </div>

      <!-- Lista de estudiantes -->
      <div id="listaEstudiantes"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 4: FORMULARIO DE OBSERVACIÃ“N
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screenObsForm" class="screen">
    <div class="header">
      <button class="btn-back" onclick="volverDeFormulario()">â†</button>
      <div style="flex:1">
        <h1 id="obsFormStudentName">Estudiante</h1>
        <div class="header-sub" id="obsFormStudentMeta"></div>
      </div>
    </div>

    <div class="scroll-area">
      <!-- Score actual -->
      <div class="card" id="obsScoreCard">
        <div class="score-display">
          <div class="score-number" id="obsScoreNumber">500</div>
          <div class="score-label" id="obsScoreLabel">SUPERIOR</div>
        </div>
      </div>

      <!-- Tipo de SituaciÃ³n -->
      <div class="card">
        <div class="card-title">Tipo de situaciÃ³n</div>
        <div class="radio-pills">
          <div class="radio-pill">
            <input type="radio" name="tipoSit" id="tipo_I" value="TIPO_I" checked onchange="actualizarFormulario()">
            <label for="tipo_I">Tipo I</label>
          </div>
          <div class="radio-pill">
            <input type="radio" name="tipoSit" id="tipo_II" value="TIPO_II" onchange="actualizarFormulario()">
            <label for="tipo_II" class="pill-grave">Tipo II</label>
          </div>
          <div class="radio-pill">
            <input type="radio" name="tipoSit" id="tipo_III" value="TIPO_III" onchange="actualizarFormulario()">
            <label for="tipo_III" class="pill-gravisima">Tipo III</label>
          </div>
        </div>
      </div>

      <!-- CategorÃ­a -->
      <div class="card">
        <div class="form-group">
          <label class="form-label required">CategorÃ­a</label>
          <select id="obsCategoria" onchange="actualizarFormulario()">
            <option value="">â€” Seleccionar â€”</option>
            <option value="ASISTENCIA">Asistencia</option>
            <option value="APRENDIZAJE">Aprendizaje</option>
            <option value="BIENES">Bienes</option>
            <option value="DESARROLLO">Desarrollo personal</option>
            <option value="RELACIONES">Relaciones interpersonales</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required">Gravedad</label>
          <div class="radio-pills">
            <div class="radio-pill">
              <input type="radio" name="gravedad" id="grav_leve" value="LEVE" checked onchange="actualizarFormulario()">
              <label for="grav_leve">Leve</label>
            </div>
            <div class="radio-pill">
              <input type="radio" name="gravedad" id="grav_grave" value="GRAVE" onchange="actualizarFormulario()">
              <label for="grav_grave" class="pill-grave">Grave</label>
            </div>
            <div class="radio-pill">
              <input type="radio" name="gravedad" id="grav_gravisima" value="GRAVISIMA" onchange="actualizarFormulario()">
              <label for="grav_gravisima" class="pill-gravisima">GravÃ­sima</label>
            </div>
          </div>
        </div>

        <!-- Puntos que descuenta -->
        <div id="puntosInfo" class="flex-between mt-8" style="font-size:0.8rem;color:var(--text-secondary);padding:8px 0;border-top:1px solid var(--border)">
          <span>Puntos que descuenta:</span>
          <span id="puntosValor" style="font-weight:700;font-family:var(--mono);color:var(--danger)">-10</span>
        </div>
      </div>

      <!-- Falta del manual -->
      <div class="card">
        <div class="form-group">
          <label class="form-label">Falta del manual de convivencia</label>
          <select id="obsFaltaManual">
            <option value="">â€” Seleccionar o escribir descripciÃ³n â€”</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label required">DescripciÃ³n de los hechos</label>
          <textarea id="obsDescripcion" placeholder="Describa brevemente lo ocurrido..." rows="3"></textarea>
        </div>
      </div>

      <!-- Detalles -->
      <div class="card">
        <div class="card-title">Detalles</div>

        <div class="flex-row gap-8">
          <div class="form-group" style="flex:1">
            <label class="form-label">Fecha del suceso</label>
            <input type="date" id="obsFechaSuceso">
          </div>
          <div class="form-group" style="flex:1">
            <label class="form-label">Hora</label>
            <input type="time" id="obsHoraSuceso">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Materia / Clase</label>
          <select id="obsMateria">
            <option value="">â€” Seleccionar â€”</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Lugar / Sitio</label>
          <select id="obsSitio">
            <option value="">â€” Seleccionar â€”</option>
            <option value="SalÃ³n de clase">SalÃ³n de clase</option>
            <option value="Patio">Patio</option>
            <option value="Cancha">Cancha</option>
            <option value="BaÃ±os">BaÃ±os</option>
            <option value="Comedor">Comedor</option>
            <option value="Biblioteca">Biblioteca</option>
            <option value="Sala de informÃ¡tica">Sala de informÃ¡tica</option>
            <option value="Laboratorio">Laboratorio</option>
            <option value="Pasillos">Pasillos</option>
            <option value="Entrada">Entrada</option>
            <option value="Fuera de la instituciÃ³n">Fuera de la instituciÃ³n</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
      </div>

      <!-- Medidas y acudiente -->
      <div class="card">
        <div class="card-title">Seguimiento</div>
        <div class="form-group">
          <label class="form-label required">Medidas tomadas</label>
          <textarea id="obsMedidas" placeholder="Â¿QuÃ© acciones se tomaron?" rows="2"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Â¿Se notificÃ³ al acudiente?</label>
          <div class="radio-pills">
            <div class="radio-pill">
              <input type="radio" name="acudiente" id="acu_no" value="NO" checked>
              <label for="acu_no">No</label>
            </div>
            <div class="radio-pill">
              <input type="radio" name="acudiente" id="acu_si" value="SI">
              <label for="acu_si">SÃ­</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Ruta de atenciÃ³n -->
      <div id="rutaAtencionCard" class="card hidden">
        <div class="card-title" id="rutaTitulo">Ruta de atenciÃ³n</div>
        <div id="rutaContenido" style="font-size:0.85rem;line-height:1.6"></div>
      </div>

      <!-- BotÃ³n guardar -->
      <button class="btn btn-primary mt-16" id="btnGuardarObs" onclick="guardarObservacion()" style="padding:16px;font-size:1.05rem">
        ğŸ’¾ Guardar observaciÃ³n
      </button>

      <div style="height:40px"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 5: HISTORIAL DEL ESTUDIANTE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screenHistory" class="screen">
    <div class="header">
      <button class="btn-back" onclick="volverDeHistorial()">â†</button>
      <div style="flex:1">
        <h1 id="histStudentName">Historial</h1>
        <div class="header-sub" id="histStudentMeta"></div>
      </div>
    </div>

    <div class="scroll-area">
      <div class="card" id="histScoreCard">
        <div class="score-display">
          <div class="score-number" id="histScoreNumber">500</div>
          <div class="score-label" id="histScoreLabel">SUPERIOR</div>
        </div>
        <div class="flex-between text-sm text-secondary" style="margin-top:8px">
          <span>Faltas: <strong id="histFaltas">0</strong></span>
          <span>Puntos desc.: <strong id="histPuntos">0</strong></span>
        </div>
      </div>

      <div class="flex-between mb-8">
        <span class="text-sm text-secondary" id="histTotal">0 observaciones</span>
        <select id="histPeriodo" onchange="cargarHistorialEstudiante()" style="width:auto;padding:6px 30px 6px 10px;font-size:0.82rem">
          <option value="">Todos</option>
          <option value="P1">P1</option>
          <option value="P2">P2</option>
          <option value="P3">P3</option>
        </select>
      </div>

      <div id="listaHistorial"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 6: MENÃš CONFIGURACIÃ“N
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screenConfig" class="screen">
    <div class="header">
      <button class="btn-back" onclick="irADashboard()">â†</button>
      <h1>Opciones</h1>
    </div>
    <div class="scroll-area">
      <div class="card">
        <div class="card-title">Datos del sistema</div>
        <div class="text-sm" style="line-height:2">
          <div>Docente: <strong id="cfgDocente">â€”</strong></div>
          <div>CÃ©dula: <strong id="cfgCedula">â€”</strong></div>
          <div>Sede: <strong id="cfgSede">â€”</strong></div>
          <div>Estudiantes cargados: <strong id="cfgEstudiantes">0</strong></div>
          <div>Periodo actual: <strong id="cfgPeriodo">â€”</strong></div>
          <div>Ãšltima sincronizaciÃ³n: <strong id="cfgSync">â€”</strong></div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="descargarDatosCompletos()">
        ğŸ“¥ Actualizar datos del sistema
      </button>
      <div class="text-sm text-secondary text-center mt-8">Descarga la lista actualizada de estudiantes y configuraciÃ³n</div>

      <button class="btn btn-outline mt-16" onclick="cerrarSesion()" style="color:var(--danger);border-color:var(--danger)">
        Cerrar sesiÃ³n
      </button>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT â€” TODA LA LÃ“GICA DE LA APP
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âš ï¸ ATOMO: Cambia esta URL por la de tu WebApp desplegada
const API_URL = 'https://script.google.com/macros/s/AKfycbz8-hfbyFDYbgVOnT00MHTMQ2N_k1rhImtN97buXwVLYsv_Y2O3LlQpltxoHXs8cXWV/exec';

const DB_NAME = 'SIGAT_Observador';
const DB_VERSION = 1;
const SESSION_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 dÃ­as

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let db = null;
let estado = {
  online: navigator.onLine,
  sesion: null,        // { token, usuario, datosAdicionales, credencialOffline }
  estudianteActual: null,
  modoActual: null,    // 'nueva' | 'historial'
  configFaltas: {},
  configPuntos: {},
  rutasAtencion: {},
  materiasPorNivel: {},
  periodoActual: 'P1'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEXEDDB â€” Almacenamiento Offline
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function abrirDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('sesion'))
        db.createObjectStore('sesion', { keyPath: 'key' });
      if (!db.objectStoreNames.contains('estudiantes')) {
        const store = db.createObjectStore('estudiantes', { keyPath: 'id' });
        store.createIndex('sede', 'sede');
        store.createIndex('grado', 'grado');
        store.createIndex('gradoGrupo', ['grado', 'grupo']);
      }
      if (!db.objectStoreNames.contains('observaciones'))
        db.createObjectStore('observaciones', { keyPath: 'idLocal' });
      if (!db.objectStoreNames.contains('observaciones_remotas'))
        db.createObjectStore('observaciones_remotas', { keyPath: 'id' });
      if (!db.objectStoreNames.contains('config'))
        db.createObjectStore('config', { keyPath: 'key' });
      if (!db.objectStoreNames.contains('docentes'))
        db.createObjectStore('docentes', { keyPath: 'id' });
    };
    req.onsuccess = () => { db = req.result; resolve(db); };
    req.onerror = () => reject(req.error);
  });
}

function dbPut(store, data) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(data);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

function dbGet(store, key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

function dbGetAll(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function dbDelete(store, key) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).delete(key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

function dbClear(store) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API â€” ComunicaciÃ³n con Google Apps Script
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function apiCall(action, datos = {}) {
  if (!estado.online) throw new Error('Sin conexiÃ³n');

  const body = {
    action: action,
    token: estado.sesion?.token || '',
    ...datos
  };

  const resp = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(body),
    headers: { 'Content-Type': 'text/plain' }
  });

  if (!resp.ok) throw new Error('Error del servidor: ' + resp.status);
  return await resp.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONEXIÃ“N â€” Detectar online/offline
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function actualizarEstadoConexion() {
  estado.online = navigator.onLine;
  const badge = document.getElementById('connBadge');
  if (estado.online) {
    badge.className = 'conn-badge online';
    badge.textContent = 'â— En lÃ­nea';
  } else {
    badge.className = 'conn-badge offline';
    badge.textContent = 'â— Sin conexiÃ³n';
  }
  actualizarSyncBar();
}

window.addEventListener('online', () => {
  actualizarEstadoConexion();
  // Auto-sincronizar cuando vuelve internet
  const pendientes = contarPendientes();
  if (pendientes > 0) {
    setTimeout(() => sincronizarAhora(), 2000);
  }
});
window.addEventListener('offline', actualizarEstadoConexion);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function mostrarPantalla(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function irADashboard() {
  actualizarDashboard();
  mostrarPantalla('screenDashboard');
}

function irANuevaObservacion() {
  estado.modoActual = 'nueva';
  document.getElementById('selectStudentTitle').textContent = 'Seleccionar estudiante';
  prepararFiltros();
  mostrarPantalla('screenSelectStudent');
}

function irAHistorial() {
  estado.modoActual = 'historial';
  document.getElementById('selectStudentTitle').textContent = 'Ver historial de...';
  prepararFiltros();
  mostrarPantalla('screenSelectStudent');
}

function mostrarMenuConfig() {
  const s = estado.sesion;
  const da = s?.datosAdicionales || {};
  document.getElementById('cfgDocente').textContent = s?.usuario?.nombreCompleto || 'â€”';
  document.getElementById('cfgCedula').textContent = da.documento || s?.usuario?.idPersona || 'â€”';
  document.getElementById('cfgSede').textContent = da.sedePrincipal || da.sede || 'â€”';
  document.getElementById('cfgEstudiantes').textContent = contarEstudiantes();
  document.getElementById('cfgPeriodo').textContent = estado.periodoActual;
  document.getElementById('cfgSync').textContent = formatearUltimaSync();
  mostrarPantalla('screenConfig');
}

function volverDeFormulario() {
  mostrarPantalla('screenSelectStudent');
}

function volverDeHistorial() {
  mostrarPantalla('screenSelectStudent');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function intentarLogin() {
  const usuario = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  const errorDiv = document.getElementById('loginError');

  if (!usuario || !password) {
    errorDiv.textContent = 'Ingresa tu cÃ©dula/correo y contraseÃ±a';
    errorDiv.classList.add('visible');
    return;
  }

  errorDiv.classList.remove('visible');

  // Intentar login online primero
  if (estado.online) {
    try {
      mostrarCargando('Verificando credenciales...');
      const resp = await apiCall('login', {
        cedula: usuario,
        email: usuario,
        password: password,
        dispositivo: 'PWA_Observador'
      });

      if (resp.exito) {
        // Guardar sesiÃ³n en IndexedDB
        const sesionData = {
          key: 'sesion_actual',
          token: resp.token,
          usuario: resp.usuario,
          datosAdicionales: resp.datosAdicionales,
          credencialOffline: resp.credencialOffline,
          identificador: usuario,
          fechaLogin: new Date().toISOString()
        };

        await dbPut('sesion', sesionData);
        estado.sesion = sesionData;

        // Descargar datos iniciales
        mostrarCargando('Descargando datos...');
        await descargarDatosCompletos();

        ocultarCargando();
        toast('Â¡Bienvenido/a!', 'success');
        irADashboard();
        return;
      } else {
        ocultarCargando();
        errorDiv.textContent = resp.mensaje || 'Credenciales incorrectas';
        errorDiv.classList.add('visible');
        return;
      }
    } catch (err) {
      ocultarCargando();
      console.warn('Login online fallÃ³, intentando offline...', err);
    }
  }

  // Intentar login offline
  const sesionGuardada = await dbGet('sesion', 'sesion_actual');
  if (sesionGuardada && sesionGuardada.identificador === usuario) {
    // Verificar que no haya expirado
    const fechaLogin = new Date(sesionGuardada.fechaLogin);
    if (new Date() - fechaLogin < SESSION_DURATION) {
      estado.sesion = sesionGuardada;
      await cargarConfigDesdeDB();
      toast('Modo sin conexiÃ³n', 'success');
      irADashboard();
      return;
    }
  }

  errorDiv.textContent = estado.online
    ? 'No se pudo conectar al servidor'
    : 'Sin conexiÃ³n. Solo puedes ingresar si ya te habÃ­as logueado antes en este dispositivo.';
  errorDiv.classList.add('visible');
}

async function cerrarSesion() {
  await dbClear('sesion');
  estado.sesion = null;
  mostrarPantalla('screenLogin');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESCARGA DE DATOS PARA OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function descargarDatosCompletos() {
  if (!estado.online) {
    toast('Sin conexiÃ³n. No se pueden actualizar datos.', 'error');
    return;
  }

  try {
    mostrarCargando('Descargando estudiantes y configuraciÃ³n...');
    const resp = await apiCall('obtenerDatosInicialesApp', {});

    if (!resp.exito) {
      throw new Error(resp.mensaje || 'Error descargando datos');
    }

    // Guardar estudiantes
    mostrarCargando(`Guardando ${resp.estudiantes.length} estudiantes...`);
    await dbClear('estudiantes');
    for (const est of resp.estudiantes) {
      await dbPut('estudiantes', est);
    }

    // Guardar docentes
    await dbClear('docentes');
    for (const doc of resp.docentes) {
      await dbPut('docentes', doc);
    }

    // Guardar configuraciÃ³n
    await dbPut('config', { key: 'configFaltas', value: resp.configFaltas });
    await dbPut('config', { key: 'configPuntos', value: resp.configPuntos });
    await dbPut('config', { key: 'rutasAtencion', value: resp.rutasAtencion });
    await dbPut('config', { key: 'materiasPorNivel', value: resp.materiasPorNivel });
    await dbPut('config', { key: 'periodoActual', value: resp.periodoActual });
    await dbPut('config', { key: 'sedes', value: resp.sedes || [] });
    await dbPut('config', { key: 'ultimaDescarga', value: new Date().toISOString() });

    // Cargar en memoria
    estado.configFaltas = resp.configFaltas || {};
    estado.configPuntos = resp.configPuntos || {};
    estado.rutasAtencion = resp.rutasAtencion || {};
    estado.materiasPorNivel = resp.materiasPorNivel || {};
    estado.periodoActual = resp.periodoActual || 'P1';

    ocultarCargando();
    toast(`${resp.estudiantes.length} estudiantes descargados`, 'success');
  } catch (err) {
    ocultarCargando();
    toast('Error: ' + err.message, 'error');
  }
}

async function cargarConfigDesdeDB() {
  try {
    const cf = await dbGet('config', 'configFaltas');
    const cp = await dbGet('config', 'configPuntos');
    const ra = await dbGet('config', 'rutasAtencion');
    const mn = await dbGet('config', 'materiasPorNivel');
    const pa = await dbGet('config', 'periodoActual');

    estado.configFaltas = cf?.value || {};
    estado.configPuntos = cp?.value || {};
    estado.rutasAtencion = ra?.value || {};
    estado.materiasPorNivel = mn?.value || {};
    estado.periodoActual = pa?.value || 'P1';
  } catch (e) {
    console.error('Error cargando config:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function actualizarDashboard() {
  const s = estado.sesion;
  if (!s) return;

  const nombre = s.usuario?.nombreCompleto || s.datosAdicionales?.nombres || 'Docente';
  const primerNombre = nombre.split(' ')[0];
  document.getElementById('dashGreeting').textContent = 'Hola, ' + primerNombre;
  document.getElementById('dashSubtitle').textContent = 'Observador Digital Â· ' + estado.periodoActual;

  // Contar observaciones de hoy
  const hoy = new Date().toISOString().split('T')[0];
  const todas = await dbGetAll('observaciones');
  const deHoy = todas.filter(o => o.timestampCreacion?.startsWith(hoy));
  const pendientes = todas.filter(o => o.estado === 'PENDIENTE');

  document.getElementById('dashTodayCount').textContent = deHoy.length;
  document.getElementById('dashPendingCount').textContent = pendientes.length;
  document.getElementById('dashSyncStatus').textContent =
    pendientes.length > 0
      ? `${pendientes.length} pendiente${pendientes.length > 1 ? 's' : ''}`
      : 'Todo al dÃ­a';
  document.getElementById('dashLastSync').textContent = formatearUltimaSync();

  actualizarSyncBar();
}

async function actualizarSyncBar() {
  const todas = await dbGetAll('observaciones');
  const pendientes = todas.filter(o => o.estado === 'PENDIENTE');
  const bar = document.getElementById('syncBar');
  const text = document.getElementById('syncBarText');

  if (pendientes.length > 0) {
    bar.classList.add('visible');
    text.textContent = estado.online
      ? `${pendientes.length} pendiente${pendientes.length > 1 ? 's' : ''} â€” Toca para sincronizar`
      : `${pendientes.length} pendiente${pendientes.length > 1 ? 's' : ''} â€” Se subirÃ¡n cuando haya internet`;
  } else {
    bar.classList.remove('visible');
  }
}

function formatearUltimaSync() {
  // placeholder â€” se actualiza despuÃ©s de sync real
  return 'Toca Sincronizar para actualizar';
}

async function contarPendientes() {
  const todas = await dbGetAll('observaciones');
  return todas.filter(o => o.estado === 'PENDIENTE').length;
}

async function contarEstudiantes() {
  const est = await dbGetAll('estudiantes');
  return est.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECCIÃ“N DE ESTUDIANTE â€” Filtros cascada
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function prepararFiltros() {
  const estudiantes = await dbGetAll('estudiantes');

  // Sedes Ãºnicas
  const sedes = [...new Set(estudiantes.map(e => e.sede).filter(Boolean))].sort();
  const selectSede = document.getElementById('filtroSede');
  selectSede.innerHTML = '<option value="">â€” Todas â€”</option>';
  sedes.forEach(s => {
    selectSede.innerHTML += `<option value="${s}">${s}</option>`;
  });

  // Grados Ãºnicos
  const grados = [...new Set(estudiantes.map(e => e.grado).filter(Boolean))];
  grados.sort((a, b) => {
    const numA = parseInt(a) || 99;
    const numB = parseInt(b) || 99;
    return numA - numB;
  });
  const selectGrado = document.getElementById('filtroGrado');
  selectGrado.innerHTML = '<option value="">Todos</option>';
  grados.forEach(g => {
    selectGrado.innerHTML += `<option value="${g}">${g}</option>`;
  });

  document.getElementById('filtroGrupo').innerHTML = '<option value="">Todos</option>';
  document.getElementById('buscarEstudiante').value = '';

  filtrarEstudiantes();
}

async function actualizarFiltrosEstudiantes() {
  const grado = document.getElementById('filtroGrado').value;
  const estudiantes = await dbGetAll('estudiantes');

  // Actualizar grupos segÃºn grado seleccionado
  if (grado) {
    const grupos = [...new Set(
      estudiantes.filter(e => e.grado === grado).map(e => e.grupo).filter(Boolean)
    )].sort();
    const selectGrupo = document.getElementById('filtroGrupo');
    selectGrupo.innerHTML = '<option value="">Todos</option>';
    grupos.forEach(g => {
      selectGrupo.innerHTML += `<option value="${g}">${g}</option>`;
    });
  }

  filtrarEstudiantes();
}

async function filtrarEstudiantes() {
  const sede = document.getElementById('filtroSede').value;
  const grado = document.getElementById('filtroGrado').value;
  const grupo = document.getElementById('filtroGrupo').value;
  const busqueda = document.getElementById('buscarEstudiante').value.toLowerCase().trim();

  let estudiantes = await dbGetAll('estudiantes');

  if (sede) estudiantes = estudiantes.filter(e => e.sede === sede);
  if (grado) estudiantes = estudiantes.filter(e => e.grado === grado);
  if (grupo) estudiantes = estudiantes.filter(e => e.grupo === grupo);
  if (busqueda) {
    estudiantes = estudiantes.filter(e =>
      (e.apellidos + ' ' + e.nombres).toLowerCase().includes(busqueda) ||
      String(e.documento).includes(busqueda)
    );
  }

  // Ordenar por apellido
  estudiantes.sort((a, b) => (a.apellidos || '').localeCompare(b.apellidos || ''));

  renderizarListaEstudiantes(estudiantes);
}

function renderizarListaEstudiantes(lista) {
  const container = document.getElementById('listaEstudiantes');

  if (lista.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <div class="empty-text">No se encontraron estudiantes</div>
      </div>`;
    return;
  }

  container.innerHTML = lista.map(e => {
    const iniciales = ((e.nombres?.[0] || '') + (e.apellidos?.[0] || '')).toUpperCase();
    return `
    <div class="student-item" onclick="seleccionarEstudiante('${e.id}')">
      <div class="student-avatar">${iniciales}</div>
      <div>
        <div class="student-name">${e.apellidos} ${e.nombres}</div>
        <div class="student-meta">${e.grado} ${e.grupo} Â· ${e.sede || ''} Â· ${e.tipoDoc || ''} ${e.documento || ''}</div>
      </div>
    </div>`;
  }).join('');
}

async function seleccionarEstudiante(id) {
  const est = await dbGet('estudiantes', id);
  if (!est) { toast('Estudiante no encontrado', 'error'); return; }

  estado.estudianteActual = est;

  if (estado.modoActual === 'nueva') {
    abrirFormularioObservacion(est);
  } else {
    abrirHistorial(est);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMULARIO DE OBSERVACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function abrirFormularioObservacion(est) {
  document.getElementById('obsFormStudentName').textContent = est.apellidos + ' ' + est.nombres;
  document.getElementById('obsFormStudentMeta').textContent = est.grado + ' ' + est.grupo + ' Â· ' + (est.sede || '');

  // Score actual
  actualizarScoreDisplay(est.id, 'obsScoreNumber', 'obsScoreLabel');

  // Defaults
  document.getElementById('tipo_I').checked = true;
  document.getElementById('obsCategoria').value = '';
  document.getElementById('grav_leve').checked = true;
  document.getElementById('obsFaltaManual').innerHTML = '<option value="">â€” Seleccionar â€”</option>';
  document.getElementById('obsDescripcion').value = '';
  document.getElementById('obsMedidas').value = '';
  document.getElementById('acu_no').checked = true;
  document.getElementById('obsSitio').value = '';

  // Fecha y hora actual
  const now = new Date();
  document.getElementById('obsFechaSuceso').value = now.toISOString().split('T')[0];
  document.getElementById('obsHoraSuceso').value = now.toTimeString().slice(0, 5);

  // Materias segÃºn grado del estudiante
  cargarMaterias(est.grado);

  actualizarFormulario();
  mostrarPantalla('screenObsForm');
}

function cargarMaterias(grado) {
  const select = document.getElementById('obsMateria');
  select.innerHTML = '<option value="">â€” Seleccionar â€”</option>';

  // Determinar nivel
  const num = parseInt(grado) || 0;
  let nivel = 'PRIMARIA';
  if (num >= 6 && num <= 9) nivel = 'SECUNDARIA';
  else if (num >= 10) nivel = 'MEDIA';

  const materias = estado.materiasPorNivel[nivel] || [];
  materias.forEach(m => {
    select.innerHTML += `<option value="${m.nombre}">${m.nombre}</option>`;
  });

  // Si no hay materias cargadas, poner genÃ©ricas
  if (materias.length === 0) {
    ['MatemÃ¡ticas', 'EspaÃ±ol', 'Ciencias Naturales', 'Ciencias Sociales',
     'InglÃ©s', 'EducaciÃ³n FÃ­sica', 'ArtÃ­stica', 'TecnologÃ­a', 'Ã‰tica', 'ReligiÃ³n'
    ].forEach(m => {
      select.innerHTML += `<option value="${m}">${m}</option>`;
    });
  }
}

function actualizarFormulario() {
  const tipo = document.querySelector('input[name="tipoSit"]:checked')?.value || 'TIPO_I';
  const categoria = document.getElementById('obsCategoria').value;
  const gravedad = document.querySelector('input[name="gravedad"]:checked')?.value || 'LEVE';

  // Actualizar puntos
  const puntos = (estado.configPuntos[categoria] || {})[gravedad] || 10;
  document.getElementById('puntosValor').textContent = '-' + puntos;

  // Actualizar faltas del manual
  actualizarFaltasManual(categoria, gravedad);

  // Mostrar ruta de atenciÃ³n
  const rutaCard = document.getElementById('rutaAtencionCard');
  const ruta = estado.rutasAtencion[tipo];
  if (ruta && tipo !== 'TIPO_I') {
    document.getElementById('rutaTitulo').textContent = ruta.nombre || tipo;
    let html = `<p style="margin-bottom:8px"><strong>Responsable:</strong> ${ruta.responsable || 'â€”'}</p>`;
    html += `<p style="margin-bottom:8px"><strong>Tiempo:</strong> ${ruta.tiempo || 'â€”'}</p>`;
    if (ruta.protocolo) {
      html += '<p style="margin-top:8px"><strong>Protocolo:</strong></p>';
      html += '<ol style="padding-left:18px;margin-top:4px">';
      ruta.protocolo.forEach(p => { html += `<li style="margin-bottom:4px">${p}</li>`; });
      html += '</ol>';
    }
    if (ruta.nota) html += `<p style="margin-top:8px;color:var(--danger);font-weight:600">${ruta.nota}</p>`;
    document.getElementById('rutaContenido').innerHTML = html;
    rutaCard.classList.remove('hidden');
  } else {
    rutaCard.classList.add('hidden');
  }
}

function actualizarFaltasManual(categoria, gravedad) {
  const select = document.getElementById('obsFaltaManual');
  select.innerHTML = '<option value="">â€” Seleccionar (opcional) â€”</option>';

  if (!categoria || !gravedad) return;

  const faltas = (estado.configFaltas[categoria] || {})[gravedad] || [];
  faltas.forEach(f => {
    select.innerHTML += `<option value="${f}">${f}</option>`;
  });
}

async function actualizarScoreDisplay(idEstudiante, numId, labelId) {
  // Calcular localmente
  const todasObs = await dbGetAll('observaciones');
  const remotas = await dbGetAll('observaciones_remotas');
  const obsEstudiante = [...todasObs, ...remotas].filter(o =>
    String(o.idEstudiante) === String(idEstudiante)
  );

  let totalPuntos = 0;
  obsEstudiante.forEach(o => {
    const cat = o.categoria || '';
    const grav = o.gravedad || '';
    const pts = (estado.configPuntos[cat] || {})[grav] || 10;
    totalPuntos += pts;
  });

  const nota = Math.max(0, 500 - totalPuntos);
  let desempeno = 'BAJO';
  let clase = 'bajo';
  if (nota >= 450) { desempeno = 'SUPERIOR'; clase = 'superior'; }
  else if (nota >= 400) { desempeno = 'ALTO'; clase = 'alto'; }
  else if (nota >= 300) { desempeno = 'BASICO'; clase = 'basico'; }

  const numEl = document.getElementById(numId);
  numEl.textContent = nota;
  numEl.className = 'score-number ' + clase;
  document.getElementById(labelId).textContent = desempeno;

  return { nota, desempeno, faltas: obsEstudiante.length, puntos: totalPuntos };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GUARDAR OBSERVACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function guardarObservacion() {
  const est = estado.estudianteActual;
  if (!est) { toast('No hay estudiante seleccionado', 'error'); return; }

  const categoria = document.getElementById('obsCategoria').value;
  const descripcion = document.getElementById('obsDescripcion').value.trim();
  const medidas = document.getElementById('obsMedidas').value.trim();

  // Validaciones
  if (!categoria) { toast('Selecciona una categorÃ­a', 'error'); return; }
  if (!descripcion) { toast('Escribe la descripciÃ³n de los hechos', 'error'); return; }
  if (!medidas) { toast('Escribe las medidas tomadas', 'error'); return; }

  const docente = estado.sesion?.datosAdicionales || {};
  const idLocal = 'LOCAL_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);

  const observacion = {
    idLocal: idLocal,
    idServidor: null,
    idEstudiante: est.id,
    periodo: estado.periodoActual,
    tipoSituacion: document.querySelector('input[name="tipoSit"]:checked')?.value || 'TIPO_I',
    categoria: categoria,
    gravedad: document.querySelector('input[name="gravedad"]:checked')?.value || 'LEVE',
    faltaManual: document.getElementById('obsFaltaManual').value || '',
    descripcion: descripcion,
    descargos: '',
    actividad: '',
    sitio: document.getElementById('obsSitio').value || '',
    materia: document.getElementById('obsMateria').value || '',
    idDocente: docente.id || docente.documento || estado.sesion?.usuario?.idPersona || '',
    nombreDocente: (docente.nombres || '') + ' ' + (docente.apellidos || ''),
    contexto: '',
    medidas: medidas,
    medidasTomadas: medidas,
    acudienteNotificado: document.querySelector('input[name="acudiente"]:checked')?.value || 'NO',
    fechaSuceso: formatearFechaParaAPI(document.getElementById('obsFechaSuceso').value),
    horaSuceso: document.getElementById('obsHoraSuceso').value + ':00',
    estado: 'PENDIENTE',
    timestampCreacion: new Date().toISOString(),
    intentosSync: 0
  };

  // Guardar en IndexedDB SIEMPRE (offline-first)
  await dbPut('observaciones', observacion);

  toast('âœ“ ObservaciÃ³n guardada', 'success');

  // Si estamos online, intentar subir inmediatamente
  if (estado.online) {
    subirObservacionIndividual(observacion);
  }

  actualizarSyncBar();
  irADashboard();
}

function formatearFechaParaAPI(dateStr) {
  if (!dateStr) return '';
  const [y, m, d] = dateStr.split('-');
  return d + '/' + m + '/' + y;
}

async function subirObservacionIndividual(obs) {
  try {
    const resp = await apiCall('registrarObservacion', {
      ...obs,
      docente: obs.idDocente
    });
    if (resp.exito) {
      obs.idServidor = resp.idObservacion;
      obs.estado = 'SINCRONIZADA';
      await dbPut('observaciones', obs);
      actualizarSyncBar();
    }
  } catch (e) {
    console.warn('Subida individual fallÃ³ (se intentarÃ¡ en sync):', e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SINCRONIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function sincronizarAhora() {
  if (!estado.online) {
    toast('Sin conexiÃ³n. Se sincronizarÃ¡ cuando haya internet.', 'error');
    return;
  }

  const todas = await dbGetAll('observaciones');
  const pendientes = todas.filter(o => o.estado === 'PENDIENTE');

  if (pendientes.length === 0) {
    toast('Todo sincronizado âœ“');
    return;
  }

  try {
    mostrarCargando(`Sincronizando ${pendientes.length} observaciones...`);

    const docente = estado.sesion?.datosAdicionales || {};
    const ultimaSync = (await dbGet('config', 'ultimaSync'))?.value || null;

    const resp = await apiCall('sincronizarObservacionesApp', {
      observacionesPendientes: pendientes.map(o => ({
        ...o,
        docente: o.idDocente
      })),
      ultimaSync: ultimaSync,
      idDocente: docente.id || docente.documento || ''
    });

    if (resp.exito) {
      // Marcar las subidas como sincronizadas
      for (const sub of (resp.subidas || [])) {
        if (sub.exito) {
          const obs = pendientes.find(p => p.idLocal === sub.idLocal);
          if (obs) {
            obs.idServidor = sub.idServidor;
            obs.estado = 'SINCRONIZADA';
            await dbPut('observaciones', obs);
          }
        }
      }

      // Guardar observaciones de otros docentes
      for (const nueva of (resp.nuevasObservaciones || [])) {
        await dbPut('observaciones_remotas', nueva);
      }

      // Guardar timestamp
      await dbPut('config', { key: 'ultimaSync', value: resp.timestampServidor });

      const subidas = (resp.subidas || []).filter(s => s.exito).length;
      const bajadas = (resp.nuevasObservaciones || []).length;

      ocultarCargando();
      toast(`âœ“ ${subidas} subidas, ${bajadas} descargadas`, 'success');
    } else {
      throw new Error(resp.mensaje || 'Error de sincronizaciÃ³n');
    }
  } catch (err) {
    ocultarCargando();
    toast('Error: ' + err.message, 'error');
  }

  actualizarSyncBar();
  actualizarDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL DE ESTUDIANTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function abrirHistorial(est) {
  document.getElementById('histStudentName').textContent = est.apellidos + ' ' + est.nombres;
  document.getElementById('histStudentMeta').textContent = est.grado + ' ' + est.grupo + ' Â· ' + (est.sede || '');
  document.getElementById('histPeriodo').value = '';

  estado.estudianteActual = est;
  mostrarPantalla('screenHistory');
  await cargarHistorialEstudiante();
}

async function cargarHistorialEstudiante() {
  const est = estado.estudianteActual;
  if (!est) return;

  const periodo = document.getElementById('histPeriodo').value;

  // Score
  const score = await actualizarScoreDisplay(est.id, 'histScoreNumber', 'histScoreLabel');
  document.getElementById('histFaltas').textContent = score.faltas;
  document.getElementById('histPuntos').textContent = score.puntos;

  // Obtener observaciones locales + remotas
  const locales = await dbGetAll('observaciones');
  const remotas = await dbGetAll('observaciones_remotas');

  let obs = [...locales, ...remotas]
    .filter(o => String(o.idEstudiante) === String(est.id));

  if (periodo) {
    obs = obs.filter(o => o.periodo === periodo || !o.periodo);
  }

  // Ordenar: mÃ¡s recientes primero
  obs.sort((a, b) => {
    const fa = new Date(a.timestampCreacion || a.fechaRegistro || 0);
    const fb = new Date(b.timestampCreacion || b.fechaRegistro || 0);
    return fb - fa;
  });

  document.getElementById('histTotal').textContent = obs.length + ' observacion' + (obs.length !== 1 ? 'es' : '');
  renderizarHistorial(obs);
}

function renderizarHistorial(observaciones) {
  const container = document.getElementById('listaHistorial');

  if (observaciones.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“‹</div>
        <div class="empty-text">Sin observaciones registradas</div>
      </div>`;
    return;
  }

  container.innerHTML = observaciones.map(o => {
    const tipoClase = (o.tipoSituacion || o.tipo || '').toLowerCase().replace('_', '-');
    const esPendiente = o.estado === 'PENDIENTE';
    const fecha = o.fechaSuceso || o.fechaRegistro || '';
    const hora = o.horaSuceso || o.horaRegistro || '';

    return `
    <div class="obs-item ${tipoClase} ${esPendiente ? 'pendiente' : ''}">
      <div class="flex-between">
        <div class="obs-date">${fecha} ${hora ? 'Â· ' + hora.slice(0, 5) : ''}</div>
        ${esPendiente ? '<span class="obs-pending-badge">â³ Pendiente</span>' : ''}
      </div>
      <div style="margin-top:4px">
        <span class="obs-type ${tipoClase}">${(o.tipoSituacion || o.tipo || '').replace('_', ' ')}</span>
        <span class="obs-type obs-cat">${o.categoria || ''}</span>
        <span class="obs-type obs-cat">${o.gravedad || ''}</span>
      </div>
      ${o.faltaManual ? `<div style="font-size:0.82rem;color:var(--text-secondary);margin-top:4px;font-style:italic">${o.faltaManual}</div>` : ''}
      <div class="obs-desc">${o.descripcion || ''}</div>
      ${o.medidas || o.medidasTomadas ? `<div style="font-size:0.82rem;margin-top:4px"><strong>Medidas:</strong> ${o.medidas || o.medidasTomadas}</div>` : ''}
      <div class="obs-teacher">ğŸ‘¤ ${o.nombreDocente || o.idDocente || 'Docente'}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILIDADES DE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast ' + type + ' visible';
  setTimeout(() => el.classList.remove('visible'), 3000);
}

function mostrarCargando(texto) {
  document.getElementById('loadingText').textContent = texto || 'Cargando...';
  document.getElementById('loadingOverlay').classList.add('visible');
}
function ocultarCargando() {
  document.getElementById('loadingOverlay').classList.remove('visible');
}

function mostrarModal(titulo, cuerpo, onConfirm) {
  document.getElementById('modalTitle').textContent = titulo;
  document.getElementById('modalBody').textContent = cuerpo;
  document.getElementById('modalConfirmBtn').onclick = () => { cerrarModal(); onConfirm(); };
  document.getElementById('modalBackdrop').classList.add('visible');
}
function cerrarModal() {
  document.getElementById('modalBackdrop').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  try {
    await abrirDB();
    actualizarEstadoConexion();

    // Verificar sesiÃ³n guardada
    const sesion = await dbGet('sesion', 'sesion_actual');
    if (sesion && sesion.token) {
      const fechaLogin = new Date(sesion.fechaLogin);
      if (new Date() - fechaLogin < SESSION_DURATION) {
        estado.sesion = sesion;
        await cargarConfigDesdeDB();
        irADashboard();
        return;
      }
    }

    // No hay sesiÃ³n, mostrar login
    mostrarPantalla('screenLogin');
  } catch (err) {
    console.error('Error de inicializaciÃ³n:', err);
    mostrarPantalla('screenLogin');
  }
}

// Registrar Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(e => console.log('SW registro fallÃ³:', e));
}

// Arrancar app
init();
</script>

</body>
</html>
