<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Observador">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>SIGAT ¬∑ Observador Digital</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê DESIGN SYSTEM ‚ïê‚ïê‚ïê */
:root {
  --bg:#f1f5f9;--surface:#fff;--surface-alt:#f8fafc;
  --primary:#0f172a;--primary-mid:#1e293b;--primary-light:#334155;
  --accent:#3b82f6;--accent-hover:#2563eb;--accent-light:#eff6ff;--accent-glow:rgba(59,130,246,.15);
  --emerald:#10b981;--emerald-bg:#ecfdf5;--emerald-dark:#059669;
  --amber:#f59e0b;--amber-bg:#fffbeb;--amber-dark:#d97706;
  --rose:#ef4444;--rose-bg:#fef2f2;--rose-dark:#dc2626;
  --violet:#8b5cf6;--violet-bg:#f5f3ff;
  --text:#0f172a;--text-mid:#475569;--text-light:#94a3b8;
  --border:#e2e8f0;--border-focus:#3b82f6;
  --radius:14px;--radius-sm:10px;--radius-xs:6px;
  --shadow-sm:0 1px 2px rgba(0,0,0,.05);
  --shadow:0 1px 3px rgba(0,0,0,.06),0 6px 16px rgba(0,0,0,.04);
  --shadow-lg:0 4px 12px rgba(0,0,0,.08),0 12px 32px rgba(0,0,0,.06);
  --font:'Outfit',system-ui,-apple-system,sans-serif;
  --mono:'JetBrains Mono',monospace;
  --safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
  --header-h:56px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px;height:100%;-webkit-text-size-adjust:100%}
body{font-family:var(--font);background:var(--bg);color:var(--text);height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;font-weight:400}
#app{height:100%;display:flex;flex-direction:column}
.screen{display:none;flex-direction:column;height:100%}
.screen.active{display:flex}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.header{background:var(--primary);color:#fff;padding:calc(var(--safe-top)+10px) 16px 10px;display:flex;align-items:center;gap:10px;flex-shrink:0;z-index:10;min-height:var(--header-h)}
.header h1{font-size:.95rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.01em}
.header-sub{font-size:.68rem;opacity:.6;font-weight:400;display:block;margin-top:1px}
.btn-icon-h{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);color:#fff;width:36px;height:36px;border-radius:10px;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s}
.btn-icon-h:active{background:rgba(255,255,255,.18)}

/* ‚ïê‚ïê‚ïê SCROLL AREA ‚ïê‚ïê‚ïê */
.scroll-area{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;padding-bottom:calc(var(--safe-bottom)+80px)}

/* ‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê */
.card{background:var(--surface);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);border:1px solid var(--border)}
.card-header{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-light);margin-bottom:10px}

/* ‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:13px 20px;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-size:.92rem;font-weight:600;cursor:pointer;transition:all .15s;-webkit-tap-highlight-color:transparent;letter-spacing:-.01em}
.btn:active{transform:scale(.98)}.btn:disabled{opacity:.45;pointer-events:none}
.btn-accent{background:var(--accent);color:#fff}.btn-accent:active{background:var(--accent-hover)}
.btn-emerald{background:var(--emerald);color:#fff}.btn-emerald:active{background:var(--emerald-dark)}
.btn-rose{background:var(--rose);color:#fff}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}
.btn-outline:active{background:var(--surface-alt);border-color:var(--accent)}
.btn-sm{padding:9px 14px;font-size:.82rem}

.action-card{background:var(--surface);border:1.5px solid var(--border);color:var(--text);padding:16px;border-radius:var(--radius);text-align:left;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s;margin-bottom:10px;font-family:var(--font);font-size:.95rem;width:100%}
.action-card:active{border-color:var(--accent);background:var(--accent-light);box-shadow:0 0 0 3px var(--accent-glow)}
.action-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
.action-label{font-weight:600;line-height:1.2}.action-desc{font-size:.78rem;color:var(--text-mid);font-weight:400;margin-top:2px}

/* ‚ïê‚ïê‚ïê FORMS ‚ïê‚ïê‚ïê */
.form-group{margin-bottom:14px}
.form-label{display:block;font-size:.78rem;font-weight:600;color:var(--text-mid);margin-bottom:5px}
.form-label.req::after{content:' *';color:var(--rose)}
input[type="text"],input[type="password"],input[type="date"],input[type="time"],select,textarea{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-size:.95rem;color:var(--text);background:var(--surface);transition:border-color .15s;-webkit-appearance:none;appearance:none}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-glow)}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
select:disabled{background-color:var(--surface-alt);color:var(--text-light);cursor:not-allowed}
textarea{resize:vertical;min-height:80px;line-height:1.5}
.search-wrap{position:relative}.search-wrap input{padding-left:38px}
.search-wrap::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:.85rem}

/* ‚ïê‚ïê‚ïê PILLS / CHIPS ‚ïê‚ïê‚ïê */
.pill-row{display:flex;gap:6px;flex-wrap:wrap}
.pill{padding:7px 14px;border:1.5px solid var(--border);border-radius:20px;background:var(--surface);font-size:.78rem;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .12s;color:var(--text-mid)}
.pill.on{background:var(--primary);color:#fff;border-color:var(--primary)}
.pill.accent{background:var(--accent);color:#fff;border-color:var(--accent)}
.pill.amber{background:var(--amber);color:#fff;border-color:var(--amber)}
.pill.rose{background:var(--rose);color:#fff;border-color:var(--rose)}

.radio-pills{display:flex;gap:8px;flex-wrap:wrap}
.radio-pill{flex:1;min-width:0}
.radio-pill input{display:none}
.radio-pill label{display:block;text-align:center;padding:10px 6px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap}
.radio-pill input:checked+label{background:var(--accent);color:#fff;border-color:var(--accent)}
.radio-pill input:checked+label.pill-amber{background:var(--amber);border-color:var(--amber)}
.radio-pill input:checked+label.pill-rose{background:var(--rose);border-color:var(--rose)}
.radio-pill input:checked+label.pill-emerald{background:var(--emerald);border-color:var(--emerald)}

/* ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê */
.tabs{display:flex;border-bottom:2px solid var(--border);flex-shrink:0;padding:0 16px;background:var(--surface)}
.tab-btn{flex:1;padding:11px 6px;border:none;background:none;font-family:var(--font);font-size:.8rem;font-weight:600;color:var(--text-light);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .12s}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}

/* ‚ïê‚ïê‚ïê STUDENT LIST ‚ïê‚ïê‚ïê */
.stu-item{display:flex;align-items:center;gap:12px;padding:13px 14px;background:var(--surface);border-radius:var(--radius-sm);margin-bottom:6px;cursor:pointer;border:1.5px solid var(--border);transition:all .12s}
.stu-item:active{border-color:var(--accent);background:var(--accent-light)}
.stu-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;flex-shrink:0}
.stu-name{font-weight:600;font-size:.9rem;line-height:1.2}.stu-meta{font-size:.75rem;color:var(--text-light);margin-top:2px}
.stu-check{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);margin-left:auto;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .12s}
.stu-item.checked .stu-check{background:var(--accent);border-color:var(--accent);color:#fff}

/* ‚ïê‚ïê‚ïê FAULTS LIST ‚ïê‚ïê‚ïê */
.fault-item{padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);margin-bottom:5px;cursor:pointer;font-size:.83rem;line-height:1.4;transition:all .12s}
.fault-item:active,.fault-item.sel{border-color:var(--accent);background:var(--accent-light)}
.fbadge{display:inline-block;font-size:.6rem;font-weight:700;padding:2px 7px;border-radius:4px;margin-right:5px;text-transform:uppercase;vertical-align:middle;letter-spacing:.3px}
.fbadge.leve{background:#dbeafe;color:#1d4ed8}.fbadge.grave{background:var(--amber-bg);color:var(--amber-dark)}.fbadge.gravisima{background:var(--rose-bg);color:var(--rose-dark)}
.faults-box{max-height:200px;overflow-y:auto;border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:6px}

/* ‚ïê‚ïê‚ïê OBSERVATION HISTORY ‚ïê‚ïê‚ïê */
.obs-card{padding:14px;background:var(--surface);border-radius:var(--radius-sm);margin-bottom:8px;border:1px solid var(--border);border-left:4px solid var(--border);cursor:pointer;transition:all .12s}
.obs-card:active{box-shadow:var(--shadow)}
.obs-card.t1{border-left-color:var(--accent)}.obs-card.t2{border-left-color:var(--amber)}.obs-card.t3{border-left-color:var(--rose)}.obs-card.logro{border-left-color:var(--emerald)}
.obs-card.pend{border-left-style:dashed;opacity:.85}
.obs-date{font-size:.7rem;color:var(--text-light);font-family:var(--mono);font-weight:500}
.obs-badge{display:inline-block;font-size:.6rem;font-weight:700;padding:2px 8px;border-radius:4px;margin:4px 4px 4px 0;text-transform:uppercase;letter-spacing:.3px}
.obs-badge.t1{background:var(--accent-light);color:var(--accent)}.obs-badge.t2{background:var(--amber-bg);color:var(--amber-dark)}.obs-badge.t3{background:var(--rose-bg);color:var(--rose-dark)}.obs-badge.logro{background:var(--emerald-bg);color:var(--emerald-dark)}
.obs-badge.cat{background:var(--surface-alt);color:var(--text-mid)}
.obs-badge.grav-leve{background:#dbeafe;color:#1d4ed8}.obs-badge.grav-grave{background:var(--amber-bg);color:var(--amber-dark)}.obs-badge.grav-gravisima{background:var(--rose-bg);color:var(--rose-dark)}
.obs-desc{font-size:.85rem;margin-top:6px;line-height:1.4;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.obs-foot{font-size:.7rem;color:var(--text-light);margin-top:8px;display:flex;justify-content:space-between;align-items:center}
.obs-pend-badge{font-size:.6rem;background:var(--amber-bg);color:var(--amber-dark);padding:2px 8px;border-radius:4px;font-weight:700}

/* ‚ïê‚ïê‚ïê SCORE ‚ïê‚ïê‚ïê */
.score-ring{text-align:center;padding:12px}
.score-num{font-size:2.6rem;font-weight:800;font-family:var(--mono);line-height:1}
.score-num.sup{color:var(--emerald)}.score-num.alt{color:var(--accent)}.score-num.bas{color:var(--amber)}.score-num.baj{color:var(--rose)}
.score-lbl{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-top:4px;color:var(--text-mid)}

/* ‚ïê‚ïê‚ïê INFO BOX ‚ïê‚ïê‚ïê */
.info{padding:12px 14px;border-radius:var(--radius-sm);font-size:.82rem;line-height:1.5;margin-bottom:12px;border-left:4px solid}
.info.blue{background:var(--accent-light);color:#1e40af;border-color:var(--accent)}
.info.amber{background:var(--amber-bg);color:var(--amber-dark);border-color:var(--amber)}
.info.rose{background:var(--rose-bg);color:var(--rose-dark);border-color:var(--rose)}
.info.emerald{background:var(--emerald-bg);color:var(--emerald-dark);border-color:var(--emerald)}
.info.locked{background:var(--surface-alt);color:var(--text-mid);border-color:var(--border);display:flex;align-items:center;gap:8px}

/* ‚ïê‚ïê‚ïê SYNC PROGRESS BAR ‚ïê‚ïê‚ïê */
.sync-strip{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:10px 16px calc(var(--safe-bottom)+10px);z-index:50;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);box-shadow:0 -2px 12px rgba(0,0,0,.06)}
.sync-strip.show{transform:translateY(0)}
.sync-info{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:.78rem;font-weight:600;color:var(--text-mid)}
.sync-bar-track{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.sync-bar-fill{height:100%;background:var(--accent);border-radius:3px;width:0%;transition:width .3s}
.sync-bar-fill.done{background:var(--emerald)}
.sync-bar-fill.error{background:var(--rose)}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast{position:fixed;top:calc(var(--safe-top)+10px);left:50%;transform:translateX(-50%) translateY(-100px);background:var(--primary);color:#fff;padding:11px 22px;border-radius:30px;font-size:.85rem;font-weight:500;box-shadow:var(--shadow-lg);z-index:200;transition:transform .3s cubic-bezier(.4,0,.2,1);white-space:nowrap;max-width:90%;text-align:center;pointer-events:auto;cursor:pointer}
.toast.vis{transform:translateX(-50%) translateY(0)}
.toast.ok{background:var(--emerald)}.toast.err{background:var(--rose)}

/* ‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê */
.loading-ov{position:fixed;inset:0;background:rgba(255,255,255,.94);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:150;gap:16px;backdrop-filter:blur(4px)}
.loading-ov.vis{display:flex}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
.loading-text{font-size:.88rem;color:var(--text-mid);font-weight:500}

/* ‚ïê‚ïê‚ïê MODAL (Bottom Sheet) ‚ïê‚ïê‚ïê */
.modal-bg{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:flex-end;justify-content:center;z-index:160;backdrop-filter:blur(2px)}
.modal-bg.vis{display:flex}
.modal-sheet{background:var(--surface);border-radius:var(--radius) var(--radius) 0 0;padding:6px 20px 24px;width:100%;max-height:88vh;overflow-y:auto}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:8px auto 14px}
.modal-sheet h3{font-size:1.05rem;font-weight:700;margin-bottom:14px}
.modal-close{position:absolute;top:16px;right:16px;background:var(--surface-alt);border:none;width:32px;height:32px;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* ‚ïê‚ïê‚ïê DETAIL BLOCKS (inside detail modal) ‚ïê‚ïê‚ïê */
.det-block{padding:12px 14px;border-radius:var(--radius-sm);margin-bottom:10px;font-size:.85rem;line-height:1.5}
.det-block.id{background:var(--amber-bg);border-left:4px solid var(--amber)}
.det-block.tipo{background:var(--accent-light);border-left:4px solid var(--accent)}
.det-block.desc{background:var(--surface-alt);border:1.5px solid var(--border)}
.det-block.descar{background:#fffde7;border-left:4px solid var(--amber)}
.det-block.medidas{background:var(--emerald-bg);border-left:4px solid var(--emerald)}
.det-block.meta{background:var(--surface-alt);font-size:.8rem;color:var(--text-mid)}
.det-label{font-weight:700;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-mid);margin-bottom:4px}
.det-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.det-grid-item{background:var(--surface-alt);padding:10px;border-radius:var(--radius-xs)}
.det-grid-item strong{font-size:.72rem;text-transform:uppercase;color:var(--text-light);display:block;margin-bottom:2px}

/* ‚ïê‚ïê‚ïê COORDINATOR QUICK PANEL ‚ïê‚ïê‚ïê */
.quick-panel{background:linear-gradient(135deg,#fef3c7,#fffbeb);border:1.5px solid #fde68a;border-radius:var(--radius);padding:16px;margin-bottom:12px}
.quick-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--amber-dark);margin-bottom:10px}
.quick-btns{display:flex;gap:10px}
.quick-btn{flex:1;padding:14px 12px;border:2px solid var(--amber);border-radius:var(--radius-sm);background:var(--surface);font-family:var(--font);font-size:.85rem;font-weight:700;cursor:pointer;text-align:center;transition:all .12s;color:var(--amber-dark)}
.quick-btn:active{background:var(--amber);color:#fff}
.quick-btn .qicon{font-size:1.5rem;display:block;margin-bottom:4px}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
.login-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:32px 24px;background:linear-gradient(180deg,var(--primary) 0%,var(--primary-mid) 40%,var(--bg) 40%)}
.login-card{background:var(--surface);border-radius:var(--radius);padding:32px 24px;width:100%;max-width:380px;box-shadow:var(--shadow-lg);margin-top:-40px}
.login-logo{font-size:2.5rem;text-align:center;margin-bottom:4px}
.login-title{font-size:1.3rem;font-weight:800;color:var(--primary);text-align:center;letter-spacing:-.02em}
.login-sub{font-size:.82rem;color:var(--text-mid);text-align:center;margin-top:2px;margin-bottom:24px}
.login-err{background:var(--rose-bg);color:var(--rose);padding:10px 14px;border-radius:var(--radius-sm);font-size:.82rem;margin-bottom:12px;display:none;border-left:4px solid var(--rose)}
.login-err.vis{display:block}
.login-footer{margin-top:20px;font-size:.72rem;color:var(--text-light);text-align:center}

/* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
.empty{text-align:center;padding:40px 20px;color:var(--text-light)}
.empty-icon{font-size:2.4rem;margin-bottom:10px}
.empty-text{font-size:.9rem}

/* ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê */
.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mb-8{margin-bottom:8px}.mb-12{margin-bottom:12px}
.gap-8{gap:8px}.text-center{text-align:center}.text-sm{font-size:.8rem}
.text-sec{color:var(--text-mid)}.flex-row{display:flex;align-items:center}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.hidden{display:none!important}
.badge-count{background:var(--rose);color:#fff;font-size:.6rem;font-weight:700;padding:2px 6px;border-radius:10px;margin-left:6px}
.protocol-step{padding:10px 14px;background:var(--surface-alt);border-radius:var(--radius-xs);margin-bottom:6px;font-size:.83rem;line-height:1.5}
.section-divider{height:1px;background:var(--border);margin:16px 0}
.filter-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}

/* ‚ïê‚ïê‚ïê CHECKBOX FILTERS ‚ïê‚ïê‚ïê */
.fcheck{display:inline-flex;align-items:center;gap:4px;font-size:.72rem;font-weight:600;cursor:pointer;padding:5px 10px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface);transition:all .12s;color:var(--text-mid)}
.fcheck input{display:none}
.fcheck.on{background:var(--primary);color:#fff;border-color:var(--primary)}
</style>
</head>
<body>

<div id="app">
  <div id="loadingOv" class="loading-ov"><div class="spinner"></div><div id="loadingTxt" class="loading-text">Cargando...</div></div>
  <div id="toast" class="toast"></div>
  <div id="modalBg" class="modal-bg" onclick="if(event.target===this)cerrarModal()"><div class="modal-sheet" id="modalSheet"><div class="modal-handle"></div><div id="modalContent"></div></div></div>
  <div id="syncStrip" class="sync-strip"><div class="sync-info"><span id="syncLabel">Sincronizando...</span><span id="syncCount"></span></div><div class="sync-bar-track"><div id="syncFill" class="sync-bar-fill"></div></div></div>

  <!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
  <div id="scrLogin" class="screen active">
    <div class="login-wrap">
      <div class="login-card">
        <div class="login-logo">üìã</div>
        <div class="login-title">Observador Digital</div>
        <div class="login-sub">IED El Triunfo ¬∑ SIGAT V2.0</div>
        <div id="loginErr" class="login-err"></div>
        <div class="form-group"><label class="form-label">N√∫mero de c√©dula</label><input type="text" id="loginUser" placeholder="Ej: 1234567890" inputmode="numeric" autocomplete="username"></div>
        <div class="form-group"><label class="form-label">Contrase√±a</label><input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
        <button class="btn btn-accent mt-8" id="btnLogin" onclick="intentarLogin()">Ingresar</button>
        <div class="login-footer">Sistema de Gesti√≥n Acad√©mica y Tecnol√≥gica</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê -->
  <div id="scrDash" class="screen">
    <div class="header">
      <div style="flex:1"><h1 id="dashGreet">Hola</h1><span class="header-sub" id="dashSub"></span></div>
      <button class="btn-icon-h" onclick="mostrarConfig()" title="Ajustes">‚öôÔ∏è</button>
    </div>
    <div class="scroll-area">
      <!-- Coordinator Quick Panel (hidden for regular teachers) -->
      <div id="quickPanel" class="quick-panel hidden">
        <div class="quick-title">‚ö° Registro r√°pido ‚Äî Coordinaci√≥n</div>
        <div class="quick-btns">
          <button class="quick-btn" onclick="iniciarFaltaRapida('RETARDO')"><span class="qicon">‚è∞</span>Retardos</button>
          <button class="quick-btn" onclick="iniciarFaltaRapida('UNIFORME')"><span class="qicon">üëî</span>Uniformes</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Resumen del d√≠a</div>
        <div class="flex-between">
          <div><div style="font-size:1.8rem;font-weight:800;font-family:var(--mono)" id="dashToday">0</div><div class="text-sm text-sec">Registradas hoy</div></div>
          <div style="text-align:right"><div style="font-size:1.8rem;font-weight:800;font-family:var(--mono)" id="dashPend">0</div><div class="text-sm text-sec">Pendientes sync</div></div>
        </div>
      </div>

      <button class="action-card" onclick="irNuevaObs()"><div class="action-icon" style="background:var(--accent-light);color:var(--accent)">üìù</div><div><div class="action-label">Nueva Observaci√≥n</div><div class="action-desc">Registrar situaci√≥n de convivencia</div></div></button>
      <button class="action-card" onclick="irNuevoLogro()"><div class="action-icon" style="background:var(--emerald-bg);color:var(--emerald)">‚≠ê</div><div><div class="action-label">Registrar Logro</div><div class="action-desc">Reconocer logros y avances positivos</div></div></button>
      <button class="action-card" onclick="irHistorial()"><div class="action-icon" style="background:var(--violet-bg);color:var(--violet)">üìä</div><div><div class="action-label">Historial</div><div class="action-desc">Consultar observaciones de un estudiante</div></div></button>
      
      <button class="btn btn-outline mt-12" id="btnSync" onclick="sincronizarAhora()" style="display:none">üîÑ Sincronizar pendientes</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SELECT STUDENT ‚ïê‚ïê‚ïê -->
  <div id="scrSelect" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="irDashboard()">‚Üê</button>
      <h1 id="selTitle">Seleccionar estudiante</h1>
    </div>
    <div style="padding:12px 16px 0;flex-shrink:0;background:var(--surface-alt)">
      <div id="sedeWrap" class="form-group mb-8">
        <select id="selSede" onchange="alCambiarSede()"><option value="">Sede...</option></select>
      </div>
      <div id="sedeLocked" class="info locked hidden">üîí <span id="sedeLockedName"></span></div>
      <div class="flex-row gap-8 mb-8">
        <select id="selGrado" onchange="alCambiarGrado()" style="flex:1"><option value="">Grado</option></select>
        <select id="selGrupo" onchange="filtrarEstudiantes()" style="flex:1"><option value="">Grupo</option></select>
      </div>
      <div class="search-wrap mb-8"><input type="text" id="busqEst" placeholder="Buscar nombre o documento..." oninput="filtrarEstudiantes()"></div>
    </div>
    <div class="scroll-area" id="listaEst"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SELECT MULTIPLE (for coordinator quick faults) ‚ïê‚ïê‚ïê -->
  <div id="scrSelectMulti" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="irDashboard()">‚Üê</button>
      <h1 id="multiTitle">Seleccionar estudiantes</h1>
      <button class="btn-icon-h" id="btnConfirmMulti" onclick="confirmarFaltaRapida()">‚úì</button>
    </div>
    <div style="padding:12px 16px 0;flex-shrink:0;background:var(--surface-alt)">
      <div id="multiSedeWrap" class="form-group mb-8">
        <select id="multiSelSede" onchange="alCambiarSedeMulti()"><option value="">Sede...</option></select>
      </div>
      <div class="flex-row gap-8 mb-8">
        <select id="multiSelGrado" onchange="alCambiarGradoMulti()" style="flex:1"><option value="">Grado</option></select>
        <select id="multiSelGrupo" onchange="filtrarEstudiantesMulti()" style="flex:1"><option value="">Grupo</option></select>
      </div>
      <div class="search-wrap mb-8"><input type="text" id="busqMulti" placeholder="Buscar..." oninput="filtrarEstudiantesMulti()"></div>
      <div class="flex-between mb-8"><span class="text-sm text-sec" id="multiCount">0 seleccionados</span><button class="btn btn-sm btn-outline" onclick="seleccionarTodos()" style="width:auto;padding:6px 12px">Seleccionar todos</button></div>
    </div>
    <div class="scroll-area" id="listaMulti"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê OBSERVATION FORM ‚ïê‚ïê‚ïê -->
  <div id="scrForm" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="volverDeForm()">‚Üê</button>
      <div style="flex:1"><h1 id="formEstName">Observaci√≥n</h1><span class="header-sub" id="formEstMeta"></span></div>
    </div>
    <div class="scroll-area">
      <div class="card">
        <div class="card-header">Tipo de situaci√≥n</div>
        <div class="info blue" style="font-size:.78rem;margin-bottom:12px">
          <b>Tipo I:</b> Conflictos manejados inadecuadamente en el aula<br>
          <b>Tipo II:</b> Situaciones de agresi√≥n escolar / acoso<br>
          <b>Tipo III:</b> Presuntos delitos contra la libertad o integridad
        </div>
        <div class="radio-pills">
          <div class="radio-pill"><input type="radio" name="tipo" id="t1" value="TIPO_I" checked><label for="t1">Tipo I</label></div>
          <div class="radio-pill"><input type="radio" name="tipo" id="t2" value="TIPO_II"><label for="t2" class="pill-amber">Tipo II</label></div>
          <div class="radio-pill"><input type="radio" name="tipo" id="t3" value="TIPO_III"><label for="t3" class="pill-rose">Tipo III</label></div>
        </div>
        <button class="btn btn-outline btn-sm mt-8" onclick="verRuta()" style="font-size:.78rem">üìã Ver protocolo / ruta de atenci√≥n</button>
      </div>

      <div class="card">
        <div class="card-header">Falta del Manual de Convivencia</div>
        <div class="search-wrap mb-8"><input type="text" id="busqFalta" placeholder="Buscar falta..." oninput="filtrarFaltas()"></div>
        <div class="pill-row mb-8" id="catFilter"></div>
        <div class="pill-row mb-8" id="gravFilter"></div>
        <div class="faults-box" id="listaFaltas"></div>
        <div id="faltaSel" class="hidden" style="margin-top:8px;padding:10px;background:var(--accent-light);border-radius:var(--radius-sm);font-size:.82rem">
          <b>Seleccionada:</b> <span id="faltaSelText"></span>
          <div class="flex-row gap-8 mt-8"><span class="fbadge" id="faltaSelCat"></span><span class="fbadge" id="faltaSelGrav"></span><span style="font-family:var(--mono);font-weight:700;font-size:.82rem" id="faltaSelPts"></span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Descripci√≥n</div>
        <div class="form-group"><label class="form-label req">Descripci√≥n detallada</label><textarea id="fDesc" placeholder="Describa la situaci√≥n ocurrida con detalle..." rows="3"></textarea></div>
        <div class="form-group"><label class="form-label">Descargos del estudiante</label><textarea id="fDescargos" placeholder="Versi√≥n del estudiante sobre los hechos..." rows="2"></textarea></div>
        <div class="form-group"><label class="form-label">Contexto / Antecedentes</label><textarea id="fContexto" placeholder="Situaciones previas relevantes..." rows="2"></textarea></div>
      </div>

      <div class="card">
        <div class="card-header">Circunstancias</div>
        <div class="flex-row gap-8 mb-12">
          <div class="form-group" style="flex:1"><label class="form-label">Fecha</label><input type="date" id="fFecha"></div>
          <div class="form-group" style="flex:1"><label class="form-label">Hora</label><input type="time" id="fHora"></div>
        </div>
        <div class="form-group"><label class="form-label">Actividad</label>
          <select id="fActividad" onchange="alCambiarActividad()">
            <option value="Actividad acad√©mica">Actividad acad√©mica</option>
            <option value="Descanso / Recreo">Descanso / Recreo</option>
            <option value="Actividad extracurricular">Actividad extracurricular</option>
            <option value="Actividad institucional">Actividad institucional</option>
            <option value="Representaci√≥n institucional">Representaci√≥n institucional</option>
            <option value="Ingreso/Salida">Ingreso / Salida</option>
          </select>
        </div>
        <div class="form-group hidden" id="wrapActDet"><label class="form-label">Especificar actividad</label><input type="text" id="fActDetalle" placeholder="¬øCu√°l actividad?"></div>
        <div class="form-group"><label class="form-label">Sitio</label>
          <select id="fSitio" onchange="alCambiarSitio()">
            <option value="Aula de clase">Aula de clase</option>
            <option value="Patio / Cancha">Patio / Cancha</option>
            <option value="Ba√±os">Ba√±os</option>
            <option value="Pasillos">Pasillos</option>
            <option value="Sala de profesores">Sala de profesores</option>
            <option value="Biblioteca">Biblioteca</option>
            <option value="Sal√≥n asignado al docente">Sal√≥n asignado al docente</option>
            <option value="Laboratorio">Laboratorio</option>
            <option value="Comedor / Tienda escolar">Comedor / Tienda escolar</option>
            <option value="Entrada de la instituci√≥n">Entrada de la instituci√≥n</option>
            <option value="Fuera de la instituci√≥n portando uniforme">Fuera de la instituci√≥n portando uniforme</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="form-group hidden" id="wrapSitioOtro"><label class="form-label">Especificar sitio</label><input type="text" id="fSitioOtro" placeholder="¬øCu√°l sitio?"></div>
        <div class="form-group" id="wrapMateria"><label class="form-label">Materia / Asignatura</label><select id="fMateria"><option value="">‚Äî No aplica ‚Äî</option></select></div>
      </div>

      <div class="card">
        <div class="card-header">Acciones</div>
        <div class="form-group"><label class="form-label req">Medidas tomadas</label><textarea id="fMedidas" placeholder="Acciones pedag√≥gicas y/o correctivas aplicadas..." rows="2"></textarea></div>
        <div class="form-group"><label class="form-label">¬øAcudiente notificado?</label>
          <div class="radio-pills"><div class="radio-pill"><input type="radio" name="acud" id="acudSi" value="SI"><label for="acudSi" class="pill-emerald">S√≠</label></div><div class="radio-pill"><input type="radio" name="acud" id="acudNo" value="NO" checked><label for="acudNo">No</label></div></div>
        </div>
      </div>

      <button class="btn btn-accent" onclick="guardarObs()" style="margin-top:4px">üíæ Guardar Observaci√≥n</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê LOGRO FORM ‚ïê‚ïê‚ïê -->
  <div id="scrLogro" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="volverDeForm()">‚Üê</button>
      <div style="flex:1"><h1 id="logroEstName">Registrar Logro</h1><span class="header-sub" id="logroEstMeta"></span></div>
    </div>
    <div class="scroll-area">
      <div class="info emerald">‚≠ê Los logros reconocen avances positivos del estudiante y quedan registrados en su historial.</div>
      <div class="card">
        <div class="form-group"><label class="form-label req">Tipo de logro</label>
          <select id="lTipo">
            <option value="Acad√©mico">üìö Acad√©mico</option>
            <option value="Deportivo">‚öΩ Deportivo</option>
            <option value="Cultural">üé® Cultural</option>
            <option value="Social">ü§ù Social</option>
            <option value="Liderazgo">üåü Liderazgo</option>
            <option value="Colaboraci√≥n">ü§≤ Colaboraci√≥n</option>
            <option value="Creatividad">üí° Creatividad</option>
            <option value="Otro">üìã Otro</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">Espacio / Actividad</label><input type="text" id="lEspacio" placeholder="¬øEn qu√© contexto ocurri√≥?"></div>
        <div class="form-group"><label class="form-label req">Descripci√≥n del logro</label><textarea id="lDesc" placeholder="Describa el logro o avance positivo del estudiante..." rows="4"></textarea></div>
      </div>
      <button class="btn btn-emerald" onclick="guardarLogro()">‚≠ê Guardar Logro</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê -->
  <div id="scrHist" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="volverDeHist()">‚Üê</button>
      <div style="flex:1"><h1 id="histEstName">Historial</h1><span class="header-sub" id="histEstMeta"></span></div>
    </div>
    <div style="padding:12px 16px 0;flex-shrink:0;background:var(--surface-alt)">
      <div id="histScore" class="score-ring"></div>
      <div class="section-divider"></div>
      <div class="card-header">Filtros</div>
      <div class="filter-row" id="filtPeriodo"></div>
      <div class="filter-row" id="filtTipo"></div>
      <div class="filter-row" id="filtGrav"></div>
      <div class="filter-row mb-12" id="filtCat"></div>
    </div>
    <div class="scroll-area" id="listaHist"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê -->
  <div id="scrConfig" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="irDashboard()">‚Üê</button>
      <h1>Configuraci√≥n</h1>
    </div>
    <div class="scroll-area">
      <div class="card">
        <div class="card-header">Sesi√≥n</div>
        <div class="text-sm"><b>Docente:</b> <span id="cfgDoc">‚Äî</span></div>
        <div class="text-sm mt-8"><b>Rol:</b> <span id="cfgRol">‚Äî</span></div>
        <div class="text-sm mt-8"><b>Sede:</b> <span id="cfgSede">‚Äî</span></div>
        <div class="text-sm mt-8"><b>Periodo:</b> <span id="cfgPer">‚Äî</span></div>
        <div class="text-sm mt-8"><b>Estudiantes:</b> <span id="cfgEst">‚Äî</span></div>
        <div class="text-sm mt-8" id="cfgConn"><b>Conexi√≥n:</b> <span id="cfgConnSt">‚Äî</span></div>
      </div>
      <button class="btn btn-accent mb-8" onclick="descargarDatos()">üîÑ Actualizar datos del sistema</button>
      <button class="btn btn-outline mb-8" onclick="sincronizarAhora()">üì§ Sincronizar pendientes</button>
      <button class="btn btn-outline mb-8" onclick="irCambiarPassword()">üîë Cambiar contrase√±a</button>
      <button id="btnRolDual" class="btn btn-outline mb-8" onclick="cambiarRolDual()" style="display:none">üîÑ Cambiar modo (Docente ‚Üî Acudiente)</button>
      <button class="btn btn-rose" onclick="cerrarSesion()">üö™ Cerrar sesi√≥n</button>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PANTALLA CAMBIAR CONTRASE√ëA ‚ïê‚ïê‚ïê -->
  <div id="scrPassword" class="screen">
    <div class="header">
      <button class="btn-icon-h" onclick="mostrarConfig()">‚Üê</button>
      <h1>Cambiar contrase√±a</h1>
    </div>
    <div class="scroll-area">
      <div class="card">
        <div class="form-group">
          <label class="form-label">Contrase√±a actual</label>
          <input type="password" id="pwdActual" placeholder="Ingrese su contrase√±a actual" autocomplete="current-password">
        </div>
        <div class="form-group" style="margin-top:12px">
          <label class="form-label">Nueva contrase√±a</label>
          <input type="password" id="pwdNueva" placeholder="M√≠nimo 4 caracteres" autocomplete="new-password">
        </div>
        <div class="form-group" style="margin-top:12px">
          <label class="form-label">Confirmar nueva contrase√±a</label>
          <input type="password" id="pwdConfirmar" placeholder="Repita la nueva contrase√±a" autocomplete="new-password">
        </div>
        <div id="pwdErr" class="login-err" style="margin-top:12px"></div>
        <div id="pwdOk" style="color:#16a34a;background:#dcfce7;padding:10px;border-radius:8px;font-weight:600;margin-top:12px;display:none"></div>
        <button class="btn btn-accent" style="margin-top:16px" onclick="ejecutarCambioPassword()">üîë Cambiar contrase√±a</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIGAT OBSERVADOR DIGITAL ‚Äî PWA V3
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const API_URL = 'https://script.google.com/macros/s/AKfycbyayz9lDldpIH-ieqJ0MtDqFfDHcqQWEnODUdy9b-knFQDDenCgaSnFDJ4f8Te4wx8j/exec';
const DB_NAME = 'SIGAT_OBS_V3';
const DB_VERSION = 2;

let db = null;

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
const S = {
  sesion: null,
  docenteInfo: { sede:'', rol:'Docente', area:'', esRolGlobal:false, id:'', nombreCompleto:'' },
  modo: 'obs',
  estudianteActual: null,
  faltasGlobal: [], faltasFiltradas: [], faltaSelIdx: -1,
  catActiva: 'TODAS', gravActiva: 'TODAS',
  configGrupos: [], sedes: [], periodoActual: 'P1',
  configPuntos: {}, rutasAtencion: {}, materiasPorNivel: {},
  tipoFaltaRapida: '', seleccionadosMulti: new Set(),
  // üîí NUEVO: Control de permisos y roles
  permisos: { puedeCrearObservacion: true, puedeVerTodos: true, soloLectura: false },
  tipoUsuario: 'Docente',
  esDocenteYAcudiente: false,
  hijosDelDocente: [],
  rolActivo: 'Docente',
  estudiantePropio: null
};

/* ‚ïê‚ïê‚ïê INDEXED DB ‚ïê‚ïê‚ïê */
function abrirDB(){
  return new Promise((ok,fail)=>{
    const r=indexedDB.open(DB_NAME,DB_VERSION);
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      ['sesion','config','docentes'].forEach(s=>{if(!d.objectStoreNames.contains(s))d.createObjectStore(s,{keyPath:'key'})});
      if(!d.objectStoreNames.contains('estudiantes')){const s=d.createObjectStore('estudiantes',{keyPath:'id'});s.createIndex('sede','sede');s.createIndex('grado','grado')}
      if(!d.objectStoreNames.contains('observaciones'))d.createObjectStore('observaciones',{keyPath:'idLocal'});
      if(!d.objectStoreNames.contains('obs_remotas'))d.createObjectStore('obs_remotas',{keyPath:'id'});
    };
    r.onsuccess=()=>{db=r.result;ok(db)};
    r.onerror=()=>fail(r.error);
  });
}
function dbPut(s,d){return new Promise((ok,fail)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).put(d);t.oncomplete=()=>ok();t.onerror=()=>fail(t.error)})}
function dbGet(s,k){return new Promise((ok,fail)=>{const t=db.transaction(s,'readonly');const r=t.objectStore(s).get(k);r.onsuccess=()=>ok(r.result||null);r.onerror=()=>fail(r.error)})}
function dbGetAll(s){return new Promise((ok,fail)=>{const t=db.transaction(s,'readonly');const r=t.objectStore(s).getAll();r.onsuccess=()=>ok(r.result||[]);r.onerror=()=>fail(r.error)})}
function dbClear(s){return new Promise((ok,fail)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).clear();t.oncomplete=()=>ok();t.onerror=()=>fail(t.error)})}
function dbDel(s,k){return new Promise((ok,fail)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).delete(k);t.oncomplete=()=>ok();t.onerror=()=>fail(t.error)})}

/* ‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê */
async function api(action, datos={}){
  const body={action,...datos};
  if(S.sesion?.token) body.token=S.sesion.token;
  const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

/* ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê */
function mostrar(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function irDashboard(){
  actualizarDash();
  // üîí ESTUDIANTE: Ir directo a su historial
  if(S.permisos.soloLectura && S.tipoUsuario==='ESTUDIANTE' && S.estudiantePropio){
    S.estudianteActual=S.estudiantePropio;
    S.modo='historial';
    initHistFilters();cargarHist();calcScore(S.estudiantePropio.id);
    document.getElementById('histHeader').textContent=S.estudiantePropio.apellidos+' '+S.estudiantePropio.nombres;
    document.getElementById('histSub').textContent=S.estudiantePropio.grado+'¬∞ '+S.estudiantePropio.grupo+' ¬∑ '+S.estudiantePropio.sede;
    mostrar('scrHist');
    return;
  }
  // üîí ACUDIENTE: Ir directo a selecci√≥n de hijos
  if(S.permisos.soloLectura && S.tipoUsuario==='ACUDIENTE'){
    S.modo='historial';
    prepararFiltros('sel');
    document.getElementById('selTitle').textContent='Seleccionar hijo/a';
    mostrar('scrSelect');
    return;
  }
  mostrar('scrDash');
}
function irNuevaObs(){S.modo='obs';document.getElementById('selTitle').textContent='Seleccionar estudiante';prepararFiltros('sel');mostrar('scrSelect')}
function irNuevoLogro(){S.modo='logro';document.getElementById('selTitle').textContent='Registrar logro de...';prepararFiltros('sel');mostrar('scrSelect')}
function irHistorial(){S.modo='historial';document.getElementById('selTitle').textContent='Ver historial de...';prepararFiltros('sel');mostrar('scrSelect')}
function volverDeForm(){mostrar('scrSelect')}
function volverDeHist(){
  if(S.permisos.soloLectura && S.tipoUsuario==='ESTUDIANTE'){mostrarConfig();return}
  if(S.permisos.soloLectura && S.tipoUsuario==='ACUDIENTE'){prepararFiltros('sel');document.getElementById('selTitle').textContent='Seleccionar hijo/a';mostrar('scrSelect');return}
  mostrar('scrSelect');
}
function mostrarConfig(){
  const s=S.sesion, d=S.docenteInfo;
  document.getElementById('cfgDoc').textContent=d.nombreCompleto||s?.usuario?.nombreCompleto||'‚Äî';
  let rolText=d.rol||d.area||S.tipoUsuario||'Docente';
  if(S.esDocenteYAcudiente){rolText=(S.rolActivo||'Docente')+' (tambi√©n '+(S.rolActivo==='Docente'?'Acudiente':'Docente')+')';}
  document.getElementById('cfgRol').textContent=rolText;
  document.getElementById('cfgSede').textContent=d.sede||'‚Äî';
  document.getElementById('cfgPer').textContent=S.periodoActual;
  dbGetAll('estudiantes').then(e=>document.getElementById('cfgEst').textContent=e.length);
  document.getElementById('cfgConnSt').textContent=navigator.onLine?'En l√≠nea':'Sin conexi√≥n';
  const btnRolDual=document.getElementById('btnRolDual');
  if(btnRolDual) btnRolDual.style.display=S.esDocenteYAcudiente?'':'none';
  mostrar('scrConfig');
}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
async function intentarLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value.trim();
  const errEl=document.getElementById('loginErr');
  if(!u||!p){errEl.textContent='Ingrese c√©dula y contrase√±a';errEl.classList.add('vis');return}
  errEl.classList.remove('vis');
  document.getElementById('btnLogin').disabled=true;
  mostrarCarga('Verificando credenciales...');
  try{
    const r=await api('loginPorCedula',{cedula:u,password:p});
    if(r.exito||r.token){
      S.sesion={token:r.token,usuario:r.usuario||{nombreCompleto:u},credencialOffline:btoa(u+':'+p),fechaLogin:Date.now()};
      await dbPut('sesion',{key:'sesion',...S.sesion});
      ocultarCarga();
      await descargarDatos();
      irDashboard();
    } else {
      ocultarCarga();errEl.textContent=r.mensaje||'Credenciales incorrectas';errEl.classList.add('vis');
    }
  }catch(e){
    // Intentar login offline
    const saved=await dbGet('sesion','sesion');
    if(saved&&saved.credencialOffline===btoa(u+':'+p)){
      S.sesion=saved;await cargarConfigDB();ocultarCarga();irDashboard();
      toast('Modo sin conexi√≥n','');
    } else {ocultarCarga();errEl.textContent='Sin conexi√≥n y sin sesi√≥n guardada';errEl.classList.add('vis')}
  }
  document.getElementById('btnLogin').disabled=false;
}
async function cerrarSesion(){await dbClear('sesion');S.sesion=null;S.permisos={puedeCrearObservacion:true,puedeVerTodos:true,soloLectura:false};S.tipoUsuario='Docente';S.esDocenteYAcudiente=false;S.hijosDelDocente=[];S.rolActivo='Docente';S.estudiantePropio=null;mostrar('scrLogin');document.getElementById('loginUser').value='';document.getElementById('loginPass').value=''}
async function ejecutarCambioPassword(){
  const actual=document.getElementById('pwdActual').value.trim();
  const nueva=document.getElementById('pwdNueva').value.trim();
  const confirmar=document.getElementById('pwdConfirmar').value.trim();
  const errEl=document.getElementById('pwdErr');
  const okEl=document.getElementById('pwdOk');
  errEl.classList.remove('vis');okEl.style.display='none';
  if(!actual){errEl.textContent='Ingrese su contrase√±a actual';errEl.classList.add('vis');return}
  if(!nueva){errEl.textContent='Ingrese la nueva contrase√±a';errEl.classList.add('vis');return}
  if(nueva.length<4){errEl.textContent='La nueva contrase√±a debe tener al menos 4 caracteres';errEl.classList.add('vis');return}
  if(nueva!==confirmar){errEl.textContent='Las contrase√±as nuevas no coinciden';errEl.classList.add('vis');return}
  if(actual===nueva){errEl.textContent='La nueva contrase√±a debe ser diferente a la actual';errEl.classList.add('vis');return}
  mostrarCarga('Cambiando contrase√±a...');
  try{
    const r=await api('cambiarPasswordPWA',{passwordActual:actual,passwordNueva:nueva});
    ocultarCarga();
    if(r.exito){
      okEl.textContent='‚úÖ Contrase√±a actualizada correctamente';okEl.style.display='block';
      document.getElementById('pwdActual').value='';document.getElementById('pwdNueva').value='';document.getElementById('pwdConfirmar').value='';
      const usuario=S.sesion?.usuario?.idPersona||document.getElementById('loginUser').value;
      S.sesion.credencialOffline=btoa(usuario+':'+nueva);
      await dbPut('sesion',{key:'sesion',...S.sesion});
    }else{errEl.textContent=r.mensaje||'Error al cambiar contrase√±a';errEl.classList.add('vis')}
  }catch(e){ocultarCarga();errEl.textContent='Error de conexi√≥n: '+e.message;errEl.classList.add('vis')}
}

// üîÑ CAMBIO DE ROL DUAL (Docente ‚Üî Acudiente)
async function cambiarRolDual(){
  if(!S.esDocenteYAcudiente) return;
  const nuevoRol=(S.rolActivo||'Docente')==='Docente'?'Acudiente':'Docente';
  S.rolActivo=nuevoRol;
  await dbPut('config',{key:'rolActivo',value:nuevoRol});
  if(nuevoRol==='Acudiente'){
    S.permisos={puedeCrearObservacion:false,puedeVerTodos:false,soloLectura:true};
    S.tipoUsuario='ACUDIENTE';
    const todosEst=await dbGetAll('estudiantes');
    const hijos=todosEst.filter(e=>S.hijosDelDocente.includes(e.id));
    await dbClear('estudiantes');for(const h of hijos) await dbPut('estudiantes',h);
    toast('Modo Acudiente activado üë®‚Äçüëß‚Äçüë¶','ok');
  }else{
    S.permisos={puedeCrearObservacion:true,puedeVerTodos:true,soloLectura:false};
    S.tipoUsuario='Docente';
    await descargarDatos();
    toast('Modo Docente activado üë®‚Äçüè´','ok');
  }
  irDashboard();
}
/* ‚ïê‚ïê‚ïê DATA DOWNLOAD ‚ïê‚ïê‚ïê */
async function descargarDatos(){
  mostrarCarga('Descargando datos...');
  try{
    const r=await api('obtenerDatosInicialesApp',{token:S.sesion?.token,documento:S.sesion?.usuario?.idPersona||S.sesion?.usuario?.nombreCompleto});
    if(!r.exito){ocultarCarga();toast(r.mensaje||'Error descargando datos','err');return}
    // Save estudiantes
    await dbClear('estudiantes');for(const e of r.estudiantes) await dbPut('estudiantes',e);
    // Save docentes
    await dbClear('docentes');for(const d of r.docentes) await dbPut('docentes',{key:d.id,...d});
    // Save remote observations
    await dbClear('obs_remotas');for(const o of(r.observacionesExistentes||[])) await dbPut('obs_remotas',o);
    // Save configs
    await dbPut('config',{key:'configGrupos',value:r.configGrupos||[]});
    await dbPut('config',{key:'sedes',value:r.sedes||[]});
    await dbPut('config',{key:'configFaltas',value:r.configFaltas||{}});
    await dbPut('config',{key:'configPuntos',value:r.configPuntos||{}});
    await dbPut('config',{key:'rutasAtencion',value:r.rutasAtencion||{}});
    await dbPut('config',{key:'materiasPorNivel',value:r.materiasPorNivel||{}});
    await dbPut('config',{key:'periodoActual',value:r.periodoActual||'P1'});
    await dbPut('config',{key:'docenteInfo',value:r.docenteInfo||{}});
    // Load into state
    S.docenteInfo=r.docenteInfo||{};
    S.configGrupos=r.configGrupos||[];
    S.sedes=r.sedes||[];
    S.configPuntos=r.configPuntos||{};
    S.rutasAtencion=r.rutasAtencion||{};
    S.materiasPorNivel=r.materiasPorNivel||{};
    S.periodoActual=r.periodoActual||'P1';
    // üîí NUEVO: Guardar permisos de seguridad
    S.permisos=r.permisos||{puedeCrearObservacion:true,puedeVerTodos:true,soloLectura:false};
    S.tipoUsuario=r.tipoUsuario||r.docenteInfo?.rol||'Docente';
    S.esDocenteYAcudiente=r.esDocenteYAcudiente||false;
    S.hijosDelDocente=r.hijosDelDocente||[];
    S.estudiantePropio=r.estudiantePropio||null;
    await dbPut('config',{key:'permisos',value:S.permisos});
    await dbPut('config',{key:'tipoUsuario',value:S.tipoUsuario});
    await dbPut('config',{key:'esDocenteYAcudiente',value:S.esDocenteYAcudiente});
    await dbPut('config',{key:'hijosDelDocente',value:S.hijosDelDocente});
    if(S.estudiantePropio) await dbPut('config',{key:'estudiantePropio',value:S.estudiantePropio});
    prepararFaltasGlobal(r.configFaltas||{});
    ocultarCarga();toast('Datos actualizados ‚úî','ok');
  }catch(e){ocultarCarga();toast('Error: '+e.message,'err')}
}

async function cargarConfigDB(){
  const get=async k=>{const r=await dbGet('config',k);return r?.value};
  S.configGrupos=await get('configGrupos')||[];
  S.sedes=await get('sedes')||[];
  S.configPuntos=await get('configPuntos')||{};
  S.rutasAtencion=await get('rutasAtencion')||{};
  S.materiasPorNivel=await get('materiasPorNivel')||{};
  S.periodoActual=await get('periodoActual')||'P1';
  S.docenteInfo=await get('docenteInfo')||{};
  // üîí NUEVO: Restaurar permisos
  S.permisos=await get('permisos')||{puedeCrearObservacion:true,puedeVerTodos:true,soloLectura:false};
  S.tipoUsuario=await get('tipoUsuario')||'Docente';
  S.esDocenteYAcudiente=await get('esDocenteYAcudiente')||false;
  S.hijosDelDocente=await get('hijosDelDocente')||[];
  S.estudiantePropio=await get('estudiantePropio')||null;
  S.rolActivo=await get('rolActivo')||'Docente';
  const faltas=await get('configFaltas')||{};
  prepararFaltasGlobal(faltas);
}

/* ‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê */
async function actualizarDash(){
  const nombre=(S.docenteInfo.nombreCompleto||S.sesion?.usuario?.nombreCompleto||'Docente').split(' ')[0];
  document.getElementById('dashGreet').textContent='Hola, '+nombre;
  document.getElementById('dashSub').textContent=(S.docenteInfo.sede||'')+(S.docenteInfo.sede?' ¬∑ ':'')+S.periodoActual;
  // Counts
  const obs=await dbGetAll('observaciones');
  const hoy=new Date().toLocaleDateString('es-CO');
  const today=obs.filter(o=>new Date(o.timestampCreacion).toLocaleDateString('es-CO')===hoy).length;
  const pend=obs.filter(o=>o.estado==='PENDIENTE').length;
  document.getElementById('dashToday').textContent=today;
  document.getElementById('dashPend').textContent=pend;
  document.getElementById('btnSync').style.display=pend>0?'flex':'none';
  // Show coordinator panel
  const esCoord=S.docenteInfo.esRolGlobal || ['Coordinador','Rector','COORDINADOR','RECTOR'].some(r=>(S.docenteInfo.rol||'').toUpperCase().includes(r.toUpperCase()));
  document.getElementById('quickPanel').classList.toggle('hidden',!esCoord||S.permisos.soloLectura);
  // üîí Ocultar/mostrar botones seg√∫n permisos
  const btnObs=document.querySelector('[onclick="irNuevaObs()"]');
  const btnLogro=document.querySelector('[onclick="irNuevoLogro()"]');
  if(btnObs) btnObs.closest('.card')? btnObs.closest('.card').style.display=S.permisos.soloLectura?'none':'': btnObs.style.display=S.permisos.soloLectura?'none':'';
  if(btnLogro) btnLogro.closest('.card')? btnLogro.closest('.card').style.display=S.permisos.soloLectura?'none':'': btnLogro.style.display=S.permisos.soloLectura?'none':'';
}

/* ‚ïê‚ïê‚ïê FILTERS (cascading) ‚ïê‚ïê‚ïê */
function prepararFiltros(prefix){
  const isMulti = prefix === 'multi';
  const selSede = document.getElementById(isMulti?'multiSelSede':'selSede');
  const sedeWrap = document.getElementById(isMulti?'multiSedeWrap':'sedeWrap');
  const sedeLocked = document.getElementById('sedeLocked');
  const selGrado = document.getElementById(isMulti?'multiSelGrado':'selGrado');
  const selGrupo = document.getElementById(isMulti?'multiSelGrupo':'selGrupo');
  
  // Determine sedes from CONFIG_GRUPOS
  const sedesDisp = [...new Set(S.configGrupos.map(g=>g.sede))].sort();
  
  if(!S.docenteInfo.esRolGlobal && S.docenteInfo.sede){
    // DOCENTE: sede locked
    if(!isMulti){
      sedeWrap.classList.add('hidden');
      sedeLocked.classList.remove('hidden');
      document.getElementById('sedeLockedName').textContent='Sede: '+S.docenteInfo.sede;
    } else {
      selSede.innerHTML=`<option value="${S.docenteInfo.sede}">${S.docenteInfo.sede}</option>`;
      selSede.value=S.docenteInfo.sede;
      selSede.disabled=true;
    }
    selSede.innerHTML=`<option value="${S.docenteInfo.sede}">${S.docenteInfo.sede}</option>`;
    selSede.value=S.docenteInfo.sede;
  } else {
    // GLOBAL role: show all sedes
    if(!isMulti){
      sedeWrap.classList.remove('hidden');
      sedeLocked.classList.add('hidden');
    }
    selSede.disabled=false;
    selSede.innerHTML='<option value="">Todas las sedes</option>'+sedesDisp.map(s=>`<option value="${s}">${s}</option>`).join('');
  }
  
  // Populate grados
  if(isMulti) alCambiarSedeMulti(); else alCambiarSede();
}

function alCambiarSede(){
  const sede=document.getElementById('selSede').value;
  const grds=[...new Set(S.configGrupos.filter(g=>!sede||g.sede===sede).map(g=>g.grado))].sort((a,b)=>{
    const na=parseInt(a),nb=parseInt(b);
    if(!isNaN(na)&&!isNaN(nb))return na-nb;
    return a.localeCompare(b);
  });
  const sel=document.getElementById('selGrado');
  sel.innerHTML='<option value="">Todos los grados</option>'+grds.map(g=>`<option value="${g}">${g}</option>`).join('');
  alCambiarGrado();
}
function alCambiarGrado(){
  const sede=document.getElementById('selSede').value;
  const grado=document.getElementById('selGrado').value;
  const grps=[...new Set(S.configGrupos.filter(g=>(!sede||g.sede===sede)&&(!grado||g.grado===grado)).map(g=>g.grupo))].sort();
  const sel=document.getElementById('selGrupo');
  sel.innerHTML='<option value="">Todos</option>'+grps.map(g=>`<option value="${g}">${g}</option>`).join('');
  filtrarEstudiantes();
}
async function filtrarEstudiantes(){
  const sede=document.getElementById('selSede').value;
  const grado=document.getElementById('selGrado').value;
  const grupo=document.getElementById('selGrupo').value;
  const busq=document.getElementById('busqEst').value.toLowerCase().trim();
  let est=await dbGetAll('estudiantes');
  if(sede)est=est.filter(e=>e.sede===sede);
  if(grado)est=est.filter(e=>e.grado===grado);
  if(grupo)est=est.filter(e=>e.grupo===grupo);
  if(busq)est=est.filter(e=>(e.apellidos+' '+e.nombres).toLowerCase().includes(busq)||String(e.documento).includes(busq));
  est.sort((a,b)=>(a.apellidos+a.nombres).localeCompare(b.apellidos+b.nombres));
  renderEstudiantes(est);
}
function renderEstudiantes(lista){
  const c=document.getElementById('listaEst');
  if(!lista.length){c.innerHTML='<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">No se encontraron estudiantes</div></div>';return}
  c.innerHTML=lista.map(e=>{
    const ini=((e.nombres?.[0]||'')+(e.apellidos?.[0]||'')).toUpperCase();
    return`<div class="stu-item" onclick="selEst('${e.id}')"><div class="stu-avatar">${ini}</div><div><div class="stu-name">${e.apellidos} ${e.nombres}</div><div class="stu-meta">${e.grado} ${e.grupo} ¬∑ ${e.sede||''}</div></div></div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê MULTI-SELECT (for coordinator quick faults) ‚ïê‚ïê‚ïê */
function alCambiarSedeMulti(){
  const sede=document.getElementById('multiSelSede').value;
  const grds=[...new Set(S.configGrupos.filter(g=>!sede||g.sede===sede).map(g=>g.grado))].sort((a,b)=>{const na=parseInt(a),nb=parseInt(b);if(!isNaN(na)&&!isNaN(nb))return na-nb;return a.localeCompare(b)});
  document.getElementById('multiSelGrado').innerHTML='<option value="">Todos</option>'+grds.map(g=>`<option value="${g}">${g}</option>`).join('');
  alCambiarGradoMulti();
}
function alCambiarGradoMulti(){
  const sede=document.getElementById('multiSelSede').value;
  const grado=document.getElementById('multiSelGrado').value;
  const grps=[...new Set(S.configGrupos.filter(g=>(!sede||g.sede===sede)&&(!grado||g.grado===grado)).map(g=>g.grupo))].sort();
  document.getElementById('multiSelGrupo').innerHTML='<option value="">Todos</option>'+grps.map(g=>`<option value="${g}">${g}</option>`).join('');
  filtrarEstudiantesMulti();
}
async function filtrarEstudiantesMulti(){
  const sede=document.getElementById('multiSelSede').value;
  const grado=document.getElementById('multiSelGrado').value;
  const grupo=document.getElementById('multiSelGrupo').value;
  const busq=document.getElementById('busqMulti').value.toLowerCase().trim();
  let est=await dbGetAll('estudiantes');
  if(sede)est=est.filter(e=>e.sede===sede);
  if(grado)est=est.filter(e=>e.grado===grado);
  if(grupo)est=est.filter(e=>e.grupo===grupo);
  if(busq)est=est.filter(e=>(e.apellidos+' '+e.nombres).toLowerCase().includes(busq)||String(e.documento).includes(busq));
  est.sort((a,b)=>(a.apellidos+a.nombres).localeCompare(b.apellidos+b.nombres));
  renderEstMulti(est);
}
function renderEstMulti(lista){
  const c=document.getElementById('listaMulti');
  if(!lista.length){c.innerHTML='<div class="empty"><div class="empty-icon">üîç</div><div class="empty-text">No se encontraron estudiantes</div></div>';return}
  c.innerHTML=lista.map(e=>{
    const ini=((e.nombres?.[0]||'')+(e.apellidos?.[0]||'')).toUpperCase();
    const checked=S.seleccionadosMulti.has(e.id);
    return`<div class="stu-item ${checked?'checked':''}" onclick="toggleMulti('${e.id}',this)"><div class="stu-avatar">${ini}</div><div><div class="stu-name">${e.apellidos} ${e.nombres}</div><div class="stu-meta">${e.grado} ${e.grupo}</div></div><div class="stu-check">${checked?'‚úì':''}</div></div>`;
  }).join('');
  document.getElementById('multiCount').textContent=S.seleccionadosMulti.size+' seleccionados';
}
function toggleMulti(id,el){
  if(S.seleccionadosMulti.has(id)){S.seleccionadosMulti.delete(id);el.classList.remove('checked');el.querySelector('.stu-check').textContent=''}
  else{S.seleccionadosMulti.add(id);el.classList.add('checked');el.querySelector('.stu-check').textContent='‚úì'}
  document.getElementById('multiCount').textContent=S.seleccionadosMulti.size+' seleccionados';
}
async function seleccionarTodos(){
  const sede=document.getElementById('multiSelSede').value;
  const grado=document.getElementById('multiSelGrado').value;
  const grupo=document.getElementById('multiSelGrupo').value;
  let est=await dbGetAll('estudiantes');
  if(sede)est=est.filter(e=>e.sede===sede);
  if(grado)est=est.filter(e=>e.grado===grado);
  if(grupo)est=est.filter(e=>e.grupo===grupo);
  const allSelected=est.every(e=>S.seleccionadosMulti.has(e.id));
  est.forEach(e=>{if(allSelected)S.seleccionadosMulti.delete(e.id);else S.seleccionadosMulti.add(e.id)});
  filtrarEstudiantesMulti();
}

/* ‚ïê‚ïê‚ïê COORDINATOR QUICK FAULTS ‚ïê‚ïê‚ïê */
function iniciarFaltaRapida(tipo){
  S.tipoFaltaRapida=tipo;
  S.seleccionadosMulti.clear();
  document.getElementById('multiTitle').textContent=tipo==='RETARDO'?'‚è∞ Seleccionar estudiantes con retardo':'üëî Seleccionar sin uniforme';
  prepararFiltros('multi');
  mostrar('scrSelectMulti');
}
async function confirmarFaltaRapida(){
  if(!S.seleccionadosMulti.size){toast('Seleccione al menos un estudiante','err');return}
  const tipo=S.tipoFaltaRapida;
  const n=S.seleccionadosMulti.size;
  const label=tipo==='RETARDO'?'retardo':'falta de uniforme';
  
  // Show confirmation in modal
  abrirModal(`<h3>Confirmar registro</h3><p style="margin-bottom:16px">¬øRegistrar <b>${label}</b> a <b>${n}</b> estudiante(s)?</p><div style="display:flex;gap:10px"><button class="btn btn-outline" onclick="cerrarModal()" style="flex:1">Cancelar</button><button class="btn btn-accent" onclick="ejecutarFaltaRapida()" style="flex:1">Confirmar</button></div>`);
}
async function ejecutarFaltaRapida(){
  cerrarModal();
  mostrarCarga('Registrando faltas...');
  try{
    if(navigator.onLine){
      const r=await api('registrarFaltaRapida',{
        tipoFalta:S.tipoFaltaRapida,
        idsEstudiantes:[...S.seleccionadosMulti],
        idDocente:S.docenteInfo.id,
        periodo:S.periodoActual
      });
      ocultarCarga();
      if(r.exito){toast(r.mensaje,'ok');S.seleccionadosMulti.clear();irDashboard()}
      else toast(r.mensaje||'Error','err');
    } else {
      // Offline: save individual observations
      const tipo=S.tipoFaltaRapida;
      const config=tipo==='RETARDO'?{tipo:'TIPO_I',cat:'ASISTENCIA',grav:'LEVE',falta:'Retardo',desc:'Retardo registrado por coordinaci√≥n',med:'Registro en observador'}
        :{tipo:'TIPO_I',cat:'DESARROLLO',grav:'LEVE',falta:'Falta de uniforme',desc:'Falta de uniforme registrada por coordinaci√≥n',med:'Registro en observador'};
      for(const idEst of S.seleccionadosMulti){
        const idLocal='QF_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
        await dbPut('observaciones',{
          idLocal,idServidor:null,idEstudiante:idEst,periodo:S.periodoActual,
          tipoSituacion:config.tipo,categoria:config.cat,gravedad:config.grav,
          faltaManual:config.falta,descripcion:config.desc,descargos:'',
          actividad:'Ingreso/Salida',sitio:'Entrada de la instituci√≥n',materia:'',
          idDocente:S.docenteInfo.id,nombreDocente:S.docenteInfo.nombreCompleto,
          contexto:'',medidas:config.med,acudienteNotificado:'NO',
          fechaSuceso:new Date().toISOString().split('T')[0],horaSuceso:new Date().toTimeString().slice(0,5),
          estado:'PENDIENTE',timestampCreacion:Date.now(),intentosSync:0
        });
      }
      ocultarCarga();toast(`${S.seleccionadosMulti.size} faltas guardadas (pendientes sync)`,'ok');
      S.seleccionadosMulti.clear();irDashboard();
    }
  }catch(e){ocultarCarga();toast('Error: '+e.message,'err')}
}

/* ‚ïê‚ïê‚ïê STUDENT SELECTION ‚ïê‚ïê‚ïê */
async function selEst(id){
  const est=(await dbGetAll('estudiantes')).find(e=>e.id===id);
  if(!est)return;
  S.estudianteActual=est;
  if(S.modo==='obs')abrirFormObs(est);
  else if(S.modo==='logro')abrirFormLogro(est);
  else if(S.modo==='historial')abrirHistorial(est);
}

/* ‚ïê‚ïê‚ïê FAULTS ‚ïê‚ïê‚ïê */
function prepararFaltasGlobal(cfg){
  const arr=[];
  if(cfg&&typeof cfg==='object'){
    for(const cat of Object.keys(cfg)){
      const items=cfg[cat];
      if(Array.isArray(items)){
        items.forEach(f=>{arr.push({texto:f.texto||f.descripcion||f.nombre||'',categoria:cat,gravedad:f.gravedad||'LEVE',puntos:f.puntos||10})});
      } else if(typeof items==='object'){
        for(const grav of Object.keys(items)){
          const list=items[grav];
          if(Array.isArray(list)) list.forEach(f=>{arr.push({texto:typeof f==='string'?f:(f.texto||f.descripcion||''),categoria:cat,gravedad:grav,puntos:f.puntos||obtenerPuntos(cat,grav)})});
        }
      }
    }
  }
  S.faltasGlobal=arr;S.faltasFiltradas=[...arr];
}
function obtenerPuntos(cat,grav){
  try{return S.configPuntos[cat]?.[grav]||10}catch(e){return 10}
}
function renderCatFilter(){
  const cats=['TODAS',...new Set(S.faltasGlobal.map(f=>f.categoria))];
  document.getElementById('catFilter').innerHTML=cats.map(c=>`<span class="pill ${c===S.catActiva?'on':''}" onclick="filtCat('${c}')">${c==='TODAS'?'Todas':c}</span>`).join('');
}
function renderGravFilter(){
  const gravs=['TODAS','LEVE','GRAVE','GRAVISIMA'];
  document.getElementById('gravFilter').innerHTML=gravs.map(g=>{
    let cls=g===S.gravActiva?'pill ':'pill ';
    if(g===S.gravActiva){
      if(g==='LEVE')cls+='accent';else if(g==='GRAVE')cls+='amber';else if(g==='GRAVISIMA')cls+='rose';else cls+='on';
    }
    return`<span class="${cls}" onclick="filtGrav('${g}')">${g==='TODAS'?'Todas':g}</span>`;
  }).join('');
}
function filtCat(c){S.catActiva=c;renderCatFilter();filtrarFaltas()}
function filtGrav(g){S.gravActiva=g;renderGravFilter();filtrarFaltas()}
function filtrarFaltas(){
  const busq=document.getElementById('busqFalta').value.toLowerCase().trim();
  S.faltasFiltradas=S.faltasGlobal.filter(f=>{
    if(S.catActiva!=='TODAS'&&f.categoria!==S.catActiva)return false;
    if(S.gravActiva!=='TODAS'&&f.gravedad!==S.gravActiva)return false;
    if(busq&&!f.texto.toLowerCase().includes(busq))return false;
    return true;
  });
  renderFaltas();
}
function renderFaltas(){
  const c=document.getElementById('listaFaltas');
  if(!S.faltasFiltradas.length){c.innerHTML='<div class="text-sm text-sec text-center" style="padding:12px">No se encontraron faltas</div>';return}
  c.innerHTML=S.faltasFiltradas.map((f,i)=>{
    const gc=f.gravedad==='GRAVE'?'grave':f.gravedad==='GRAVISIMA'?'gravisima':'leve';
    return`<div class="fault-item ${i===S.faltaSelIdx?'sel':''}" onclick="selFalta(${i})"><span class="fbadge ${gc}">${f.gravedad}</span>${f.texto}</div>`;
  }).join('');
}
function selFalta(i){
  S.faltaSelIdx=i;
  const f=S.faltasFiltradas[i];
  document.getElementById('faltaSel').classList.remove('hidden');
  document.getElementById('faltaSelText').textContent=f.texto;
  const gc=f.gravedad==='GRAVE'?'grave':f.gravedad==='GRAVISIMA'?'gravisima':'leve';
  document.getElementById('faltaSelCat').className='fbadge leve';document.getElementById('faltaSelCat').textContent=f.categoria;
  document.getElementById('faltaSelGrav').className='fbadge '+gc;document.getElementById('faltaSelGrav').textContent=f.gravedad;
  document.getElementById('faltaSelPts').textContent='-'+f.puntos+' pts';
  renderFaltas();
}

/* ‚ïê‚ïê‚ïê OBSERVATION FORM ‚ïê‚ïê‚ïê */
function abrirFormObs(est){
  document.getElementById('formEstName').textContent=est.apellidos+' '+est.nombres;
  document.getElementById('formEstMeta').textContent=est.grado+' '+est.grupo+' ¬∑ '+est.sede;
  // Reset
  document.getElementById('t1').checked=true;
  S.faltaSelIdx=-1;S.catActiva='TODAS';S.gravActiva='TODAS';
  document.getElementById('faltaSel').classList.add('hidden');
  document.getElementById('busqFalta').value='';
  document.getElementById('fDesc').value='';
  document.getElementById('fDescargos').value='';
  document.getElementById('fContexto').value='';
  const hoy=new Date();
  document.getElementById('fFecha').value=hoy.toISOString().split('T')[0];
  document.getElementById('fHora').value=hoy.toTimeString().slice(0,5);
  document.getElementById('fActividad').value='Actividad acad√©mica';
  document.getElementById('wrapActDet').classList.add('hidden');
  document.getElementById('fSitio').value='Aula de clase';
  document.getElementById('wrapSitioOtro').classList.add('hidden');
  document.getElementById('fMedidas').value='';
  document.getElementById('acudNo').checked=true;
  // Load materias
  cargarMaterias(est.grado);
  renderCatFilter();renderGravFilter();filtrarFaltas();
  mostrar('scrForm');
}
function cargarMaterias(grado){
  const sel=document.getElementById('fMateria');
  sel.innerHTML='<option value="">‚Äî No aplica ‚Äî</option>';
  const mats=S.materiasPorNivel[grado]||S.materiasPorNivel['TODOS']||[];
  mats.forEach(m=>sel.innerHTML+=`<option value="${m.nombre}">${m.nombre}</option>`);
  actualizarVisibilidadMateria();
}
function alCambiarActividad(){
  const v=document.getElementById('fActividad').value;
  document.getElementById('wrapActDet').classList.toggle('hidden',!['Actividad extracurricular','Actividad institucional','Representaci√≥n institucional'].includes(v));
  actualizarVisibilidadMateria();
}
function alCambiarSitio(){
  document.getElementById('wrapSitioOtro').classList.toggle('hidden',document.getElementById('fSitio').value!=='Otro');
  actualizarVisibilidadMateria();
}
function actualizarVisibilidadMateria(){
  const act=document.getElementById('fActividad').value;
  const sitio=document.getElementById('fSitio').value;
  const mostrar=act==='Actividad acad√©mica'||sitio==='Aula de clase'||sitio==='Sal√≥n asignado al docente';
  document.getElementById('wrapMateria').classList.toggle('hidden',!mostrar);
}

/* ‚ïê‚ïê‚ïê ROUTES / PROTOCOL ‚ïê‚ïê‚ïê */
function verRuta(){
  const tipo=document.querySelector('input[name="tipo"]:checked').value;
  const rutas=S.rutasAtencion;
  let ruta=rutas[tipo]||rutas['TIPO_I']||null;
  let html='<h3>üìã Ruta de Atenci√≥n ‚Äî '+tipo.replace('_',' ')+'</h3>';
  if(ruta){
    if(ruta.nombre)html+=`<div class="info blue mb-12"><b>${ruta.nombre}</b>${ruta.articulo?' ¬∑ '+ruta.articulo:''}</div>`;
    if(ruta.protocolo&&Array.isArray(ruta.protocolo)){
      html+=ruta.protocolo.map((p,i)=>`<div class="protocol-step"><b>Paso ${i+1}:</b> ${p}</div>`).join('');
    }
    if(ruta.responsable)html+=`<div class="info amber mt-12"><b>Responsable:</b> ${ruta.responsable}${ruta.tiempo?' ¬∑ <b>Tiempo:</b> '+ruta.tiempo:''}</div>`;
    if(ruta.nota)html+=`<div class="info" style="background:#f8fafc;border-color:var(--border);color:var(--text-mid);margin-top:8px"><b>Nota:</b> ${ruta.nota}</div>`;
  } else {
    html+='<div class="info amber">No hay ruta configurada para este tipo. Consulte el Manual de Convivencia.</div>';
  }
  abrirModal(html);
}

/* ‚ïê‚ïê‚ïê SAVE OBSERVATION ‚ïê‚ïê‚ïê */

async function guardarObs(){
  if(S.permisos.soloLectura||!S.permisos.puedeCrearObservacion){toast('No tiene permisos para registrar observaciones','err');return}
  if(S._guardando)return;
  const est=S.estudianteActual;if(!est)return;
  const desc=document.getElementById('fDesc').value.trim();
  const medidas=document.getElementById('fMedidas').value.trim();
  if(!desc||desc.length<10){toast('Descripci√≥n muy corta (m√≠n 10 caracteres)','err');return}
  if(!medidas){toast('Indique las medidas tomadas','err');return}
  
  S._guardando=true; // ‚Üê Bloquear
  
  const tipo=document.querySelector('input[name="tipo"]:checked').value;
  const falta=S.faltaSelIdx>=0?S.faltasFiltradas[S.faltaSelIdx]:null;
  let sitio=document.getElementById('fSitio').value;
  if(sitio==='Otro')sitio=document.getElementById('fSitioOtro').value.trim()||'Otro';
  let actividad=document.getElementById('fActividad').value;
  const detAct=document.getElementById('fActDetalle').value.trim();
  if(detAct)actividad+=' ‚Äî '+detAct;
  const acud=document.querySelector('input[name="acud"]:checked').value;
  
  const idLocal='OBS_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
  const obs={
    idLocal, idServidor:null, idEstudiante:est.id, periodo:S.periodoActual,
    tipoSituacion:tipo,
    categoria:falta?.categoria||'',
    gravedad:falta?.gravedad||'',
    faltaManual:falta?.texto||'',
    descripcion:desc,
    descargos:document.getElementById('fDescargos').value.trim(),
    actividad:actividad,
    sitio:sitio,
    materia:document.getElementById('fMateria').value,
    idDocente:S.docenteInfo.id,
    nombreDocente:S.docenteInfo.nombreCompleto,
    contexto:document.getElementById('fContexto').value.trim(),
    medidas:medidas,
    acudienteNotificado:acud,
    fechaSuceso:document.getElementById('fFecha').value,
    horaSuceso:document.getElementById('fHora').value,
    estado:'PENDIENTE',
    timestampCreacion:Date.now(),
    intentosSync:0
  };
  
  await dbPut('observaciones',obs);
  toast('Observaci√≥n guardada ‚úì','ok');
  
  // Try immediate sync ‚Äî AHORA con await para que termine antes de navegar
  if(navigator.onLine){try{await subirObs(obs)}catch(e){}}
  S._guardando=false; // ‚Üê Desbloquear
  irDashboard();
}

async function subirObs(obs){
  try{
    const r=await api('registrarObservacion',{
      idLocal:obs.idLocal, idEstudiante:obs.idEstudiante, periodo:obs.periodo,
      tipoSituacion:obs.tipoSituacion, categoria:obs.categoria, gravedad:obs.gravedad,
      faltaManual:obs.faltaManual, descripcion:obs.descripcion, descargos:obs.descargos,
      actividad:obs.actividad, sitio:obs.sitio, materia:obs.materia,
      idDocente:obs.idDocente, contexto:obs.contexto, medidas:obs.medidas,
      acudienteNotificado:obs.acudienteNotificado,
      fechaSuceso:obs.fechaSuceso, horaSuceso:obs.horaSuceso
    });
    if(r.exito){
      obs.estado='SINCRONIZADA';obs.idServidor=r.idObservacion;
      await dbPut('observaciones',obs);
    }
  }catch(e){obs.intentosSync=(obs.intentosSync||0)+1;await dbPut('observaciones',obs)}
}

/* ‚ïê‚ïê‚ïê LOGRO FORM ‚ïê‚ïê‚ïê */
function abrirFormLogro(est){
  document.getElementById('logroEstName').textContent=est.apellidos+' '+est.nombres;
  document.getElementById('logroEstMeta').textContent=est.grado+' '+est.grupo;
  document.getElementById('lTipo').value='Acad√©mico';
  document.getElementById('lEspacio').value='';
  document.getElementById('lDesc').value='';
  mostrar('scrLogro');
}
async function guardarLogro(){
  const est=S.estudianteActual;if(!est)return;
  const desc=document.getElementById('lDesc').value.trim();
  if(!desc||desc.length<5){toast('Descripci√≥n muy corta','err');return}
  
  const idLocal='LOG_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
  const obs={
    idLocal, idServidor:null, idEstudiante:est.id, periodo:S.periodoActual,
    tipoSituacion:'LOGRO', categoria:document.getElementById('lTipo').value,
    gravedad:'', faltaManual:'', descripcion:desc, descargos:'',
    actividad:document.getElementById('lEspacio').value.trim(), sitio:'', materia:'',
    idDocente:S.docenteInfo.id, nombreDocente:S.docenteInfo.nombreCompleto,
    contexto:'', medidas:'', acudienteNotificado:'',
    fechaSuceso:new Date().toISOString().split('T')[0], horaSuceso:new Date().toTimeString().slice(0,5),
    estado:'PENDIENTE', timestampCreacion:Date.now(), intentosSync:0
  };
  await dbPut('observaciones',obs);
  toast('Logro registrado ‚úì','ok');
  if(navigator.onLine){
    try{
      const r=await api('guardarLogroPWA',{idLocal:obs.idLocal,idEstudiante:est.id,periodo:S.periodoActual,tipoLogro:obs.categoria,espacio:obs.actividad,descripcion:desc,idDocente:S.docenteInfo.id});
      if(r.exito){obs.estado='SINCRONIZADA';obs.idServidor=r.idLogro;await dbPut('observaciones',obs)}
    }catch(e){}
  }
  irDashboard();
}

/* ‚ïê‚ïê‚ïê SYNC ‚ïê‚ïê‚ïê */
async function sincronizarAhora(){
  const obs=(await dbGetAll('observaciones')).filter(o=>o.estado==='PENDIENTE');
  if(!obs.length){toast('Todo sincronizado ‚úì','ok');return}
  
  const strip=document.getElementById('syncStrip');
  const fill=document.getElementById('syncFill');
  const label=document.getElementById('syncLabel');
  const count=document.getElementById('syncCount');
  
  strip.classList.add('show');fill.style.width='0%';fill.className='sync-bar-fill';
  let ok=0,fail=0;
  
  for(let i=0;i<obs.length;i++){
    const o=obs[i];
    label.textContent=`Sincronizando ${i+1} de ${obs.length}...`;
    count.textContent=`${ok} ‚úì  ${fail} ‚úó`;
    fill.style.width=((i+1)/obs.length*100)+'%';
    
    try{
      const isLogro=o.tipoSituacion==='LOGRO';
      const action=isLogro?'guardarLogroPWA':'registrarObservacion';
      const datos=isLogro?{idLocal:o.idLocal,idEstudiante:o.idEstudiante,periodo:o.periodo,tipoLogro:o.categoria,espacio:o.actividad,descripcion:o.descripcion,idDocente:o.idDocente}
        :{idLocal:o.idLocal,idEstudiante:o.idEstudiante,periodo:o.periodo,tipoSituacion:o.tipoSituacion,categoria:o.categoria,gravedad:o.gravedad,faltaManual:o.faltaManual,descripcion:o.descripcion,descargos:o.descargos,actividad:o.actividad,sitio:o.sitio,materia:o.materia,idDocente:o.idDocente,contexto:o.contexto,medidas:o.medidas,acudienteNotificado:o.acudienteNotificado,fechaSuceso:o.fechaSuceso,horaSuceso:o.horaSuceso};
      const r=await api(action,datos);
      if(r.exito){o.estado='SINCRONIZADA';o.idServidor=r.idObservacion||r.idLogro;await dbPut('observaciones',o);ok++}
      else{o.intentosSync++;await dbPut('observaciones',o);fail++}
    }catch(e){o.intentosSync++;await dbPut('observaciones',o);fail++}
  }
  
  label.textContent=fail?`Completado: ${ok} ‚úì, ${fail} con error`:'¬°Todo sincronizado!';
  count.textContent='';
  fill.style.width='100%';
  fill.classList.add(fail?'error':'done');
  setTimeout(()=>{strip.classList.remove('show');actualizarDash()},2500);
}

/* ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê */
async function abrirHistorial(est){
  document.getElementById('histEstName').textContent=est.apellidos+' '+est.nombres;
  document.getElementById('histEstMeta').textContent=est.grado+' '+est.grupo+' ¬∑ '+est.sede;
  initHistFilters();
  await calcScore(est.id);
  await cargarHist();
  mostrar('scrHist');
}
function initHistFilters(){
  const mk=(id,vals,labels)=>{
    document.getElementById(id).innerHTML=(labels||vals).map((l,i)=>`<span class="fcheck on" onclick="toggleFcheck(this)"><input type="checkbox" value="${vals[i]}" checked>${l}</span>`).join('');
  };
  mk('filtPeriodo',['P1','P2','P3']);
  mk('filtTipo',['TIPO_I','TIPO_II','TIPO_III','LOGRO'],['Tipo I','Tipo II','Tipo III','Logro']);
  mk('filtGrav',['LEVE','GRAVE','GRAVISIMA'],['Leve','Grave','Grav√≠sima']);
  mk('filtCat',['ASISTENCIA','APRENDIZAJE','BIENES','DESARROLLO','RELACIONES']);
}
function toggleFcheck(el){el.classList.toggle('on');el.querySelector('input').checked=el.classList.contains('on');cargarHist()}
function getChecked(id){return[...document.querySelectorAll(`#${id} input:checked`)].map(i=>i.value)}


async function cargarHist(){
  const id=S.estudianteActual?.id;if(!id)return;
  const fPer=getChecked('filtPeriodo'),fTipo=getChecked('filtTipo'),fGrav=getChecked('filtGrav'),fCat=getChecked('filtCat');
  // Combine local + remote
  let all=[];
  const local=await dbGetAll('observaciones');
  const remote=await dbGetAll('obs_remotas');
  // Map local
  local.filter(o=>o.idEstudiante===id).forEach(o=>{all.push({...o,source:'local'})});
  // Map remote (avoid duplicates from local synced ones)
  const localIds=new Set(local.filter(o=>o.idServidor).map(o=>o.idServidor));
  remote.filter(o=>o.idEstudiante===id&&!localIds.has(o.id)).forEach(o=>{
    all.push({id:o.id,idEstudiante:o.idEstudiante,periodo:o.periodo,tipoSituacion:o.tipo,categoria:o.categoria,gravedad:o.gravedad,faltaManual:o.faltaManual,descripcion:o.descripcion,descargos:o.descargos,actividad:o.actividad,sitio:o.sitio,materia:o.materia,idDocente:o.idDocente,contexto:o.contexto,medidas:o.medidas,acudienteNotificado:o.acudienteNotificado,fechaSuceso:o.fechaSuceso||o.fechaRegistro,horaSuceso:o.horaSuceso||o.horaRegistro,fechaRegistro:o.fechaRegistro,horaRegistro:o.horaRegistro,estado:'SINCRONIZADA',source:'remote'});
  });
  // Filter
  all=all.filter(o=>{
    if(fPer.length&&o.periodo&&!fPer.includes(o.periodo))return false;
    const t=o.tipoSituacion||o.tipo;if(fTipo.length&&t&&!fTipo.includes(t))return false;
    if(fGrav.length&&o.gravedad&&!fGrav.includes(o.gravedad))return false;
    if(fCat.length&&o.categoria&&!fCat.includes(o.categoria)&&t!=='LOGRO')return false;
    return true;
  });
  // Sort newest first
  all.sort((a,b)=>(b.timestampCreacion||0)-(a.timestampCreacion||0)||(b.fechaRegistro||'').localeCompare(a.fechaRegistro||''));
  renderHist(all);
}

function renderHist(obs){
  const c=document.getElementById('listaHist');
  if(!obs.length){c.innerHTML='<div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">No hay observaciones con estos filtros</div></div>';return}
  c.innerHTML=obs.map(o=>{
    const t=o.tipoSituacion||o.tipo||'';
    const tc=t==='TIPO_I'?'t1':t==='TIPO_II'?'t2':t==='TIPO_III'?'t3':t==='LOGRO'?'logro':'';
    const pend=o.estado==='PENDIENTE';
    const fecha=o.fechaSuceso||o.fechaRegistro||'';
    const hora=o.horaSuceso||o.horaRegistro||'';
    const docName=resolverDocente(o.idDocente,o.nombreDocente);
    const gc=o.gravedad==='GRAVE'?'grav-grave':o.gravedad==='GRAVISIMA'?'grav-gravisima':o.gravedad?'grav-leve':'';
    return`<div class="obs-card ${tc} ${pend?'pend':''}" onclick='verDetalle(${JSON.stringify(o).replace(/'/g,"\\'")})'><div class="obs-date">${fecha} ${hora}</div><div><span class="obs-badge ${tc}">${t.replace('_',' ')}</span>${o.categoria?`<span class="obs-badge cat">${o.categoria}</span>`:''}${o.gravedad?`<span class="obs-badge ${gc}">${o.gravedad}</span>`:''}</div><div class="obs-desc">${o.faltaManual||o.descripcion||''}</div><div class="obs-foot"><span>üë§ ${docName}</span>${pend?'<span class="obs-pend-badge">‚è≥ Pendiente</span>':''}</div></div>`;
  }).join('');
}

function resolverDocente(id,nombre){
  if(nombre)return nombre;
  if(!id)return 'No especificado';
  // Search docentes in IndexedDB cache (we can use sync approach since we loaded them)
  // For performance, we'll search from the global state
  const searchId=String(id);
  // Try to find in the loaded page ‚Äî we'll use a simple cache
  if(window._docentesCache){
    for(const d of window._docentesCache){
      if(d.id===searchId||d.documento===searchId||searchId.includes(d.documento)||d.id.includes(searchId)){
        return d.nombreCompleto||(d.nombres+' '+d.apellidos).trim();
      }
    }
  }
  return id;
}

// Load docentes cache at startup
async function loadDocentesCache(){
  try{
    const all=await dbGetAll('docentes');
    window._docentesCache=all.map(d=>({id:d.key||d.id,nombres:d.nombres||'',apellidos:d.apellidos||'',documento:d.documento||'',nombreCompleto:d.nombreCompleto||(d.nombres+' '+d.apellidos).trim()}));
  }catch(e){window._docentesCache=[]}
}

async function calcScore(idEst){
  const local=await dbGetAll('observaciones');
  const remote=await dbGetAll('obs_remotas');
  let totalPts=0,faltas=0;
  const localIds=new Set(local.filter(o=>o.idServidor).map(o=>o.idServidor));
  const allObs=[...local.filter(o=>o.idEstudiante===idEst),...remote.filter(o=>o.idEstudiante===idEst&&!localIds.has(o.id))];
  allObs.forEach(o=>{
    const t=o.tipoSituacion||o.tipo||'';
    if(t==='LOGRO')return;
    const cat=o.categoria||'';
    const grav=o.gravedad||'';
    const pts=obtenerPuntos(cat,grav);
    totalPts+=pts;faltas++;
  });
  const nota=Math.max(0,500-totalPts);
  let desemp,cls;
  if(nota>=450){desemp='SUPERIOR';cls='sup'}else if(nota>=400){desemp='ALTO';cls='alt'}else if(nota>=300){desemp='B√ÅSICO';cls='bas'}else{desemp='BAJO';cls='baj'}
  document.getElementById('histScore').innerHTML=`<div class="score-num ${cls}">${nota}</div><div class="score-lbl">${desemp}</div><div class="text-sm text-sec mt-8">${faltas} falta(s) ¬∑ ${totalPts} pts descontados</div>`;
}

/* ‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê */
function verDetalle(o){
  const t=o.tipoSituacion||o.tipo||'';
  const docName=resolverDocente(o.idDocente,o.nombreDocente);
  let html=`<h3>üìã Detalle de Observaci√≥n</h3>`;
  
  // ID & dates
  html+=`<div class="det-block id"><b>ID:</b> ${o.id||o.idLocal||'‚Äî'}<br><b>üìÖ Suceso:</b> ${o.fechaSuceso||'‚Äî'} ${o.horaSuceso||''}<br><b>üìÖ Registro:</b> ${o.fechaRegistro||new Date(o.timestampCreacion).toLocaleDateString('es-CO')||'‚Äî'} ${o.horaRegistro||''}</div>`;
  
  // Type info
  html+=`<div class="det-block tipo"><b>üéØ Tipo:</b> ${t.replace('_',' ')}<br><b>üìÇ Categor√≠a:</b> ${o.categoria||'‚Äî'}<br><b>‚ö†Ô∏è Gravedad:</b> ${o.gravedad||'‚Äî'}</div>`;
  
  // Fault
  if(o.faltaManual)html+=`<div class="det-block desc"><div class="det-label">üìã Falta del Manual</div>${o.faltaManual}</div>`;
  
  // Description
  html+=`<div class="det-block desc"><div class="det-label">üìù Descripci√≥n</div><div style="white-space:pre-wrap">${o.descripcion||'‚Äî'}</div></div>`;
  
  // Descargos
  if(o.descargos)html+=`<div class="det-block descar"><div class="det-label">‚öñÔ∏è Descargos del Estudiante</div><div style="white-space:pre-wrap">${o.descargos}</div></div>`;
  
  // Context
  if(o.contexto)html+=`<div class="det-block desc"><div class="det-label">üîÑ Contexto / Antecedentes</div><div style="white-space:pre-wrap">${o.contexto}</div></div>`;
  
  // Circumstances grid
  const hasCirc=o.actividad||o.sitio||o.materia;
  if(hasCirc){
    html+='<div class="det-grid">';
    if(o.actividad)html+=`<div class="det-grid-item"><strong>Actividad</strong>${o.actividad}</div>`;
    if(o.sitio)html+=`<div class="det-grid-item"><strong>Sitio</strong>${o.sitio}</div>`;
    if(o.materia)html+=`<div class="det-grid-item"><strong>Asignatura</strong>${o.materia}</div>`;
    html+='</div>';
  }
  
  // Measures
  if(o.medidas)html+=`<div class="det-block medidas mt-12"><div class="det-label">‚úÖ Medidas tomadas</div><div style="white-space:pre-wrap">${o.medidas}</div></div>`;
  
  // Footer
  html+=`<div class="det-block meta mt-8"><b>üë§ Registrada por:</b> ${docName}<br><b>üìû Acudiente notificado:</b> ${o.acudienteNotificado||'‚Äî'}</div>`;
  
// ‚úÖ DESPU√âS:
  if(o.estado==='PENDIENTE')html+=`<div class="info amber mt-8">‚è≥ Esta observaci√≥n est√° pendiente de sincronizaci√≥n.</div>`;
  
  html+=`<button class="btn btn-outline mt-12" onclick="cerrarModal()" style="margin-bottom:8px">‚Üê Volver al historial</button>`;
  
  abrirModal(html);
}

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
function abrirModal(html){document.getElementById('modalContent').innerHTML=html;document.getElementById('modalBg').classList.add('vis')}
function cerrarModal(){document.getElementById('modalBg').classList.remove('vis')}

/* ‚ïê‚ïê‚ïê TOAST / LOADING ‚ïê‚ïê‚ïê */
function toast(m,t){const e=document.getElementById('toast');e.textContent=m;e.className='toast '+(t||'')+' vis';e.onclick=()=>e.classList.remove('vis');clearTimeout(window._toastTimer);window._toastTimer=setTimeout(()=>e.classList.remove('vis'),2000)}
function mostrarCarga(t){document.getElementById('loadingTxt').textContent=t||'Cargando...';document.getElementById('loadingOv').classList.add('vis')}
function ocultarCarga(){document.getElementById('loadingOv').classList.remove('vis')}

/* ‚ïê‚ïê‚ïê AUTO-SYNC ON RECONNECT ‚ïê‚ïê‚ïê */
window.addEventListener('online',()=>{
  setTimeout(async()=>{
    const pend=(await dbGetAll('observaciones')).filter(o=>o.estado==='PENDIENTE');
    if(pend.length>0) sincronizarAhora();
  },1500);
});

/* ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê */
async function init(){
  await abrirDB();
  const saved=await dbGet('sesion','sesion');
  if(saved&&saved.token){
    S.sesion=saved;
    await cargarConfigDB();
    await loadDocentesCache();
    irDashboard();
    // Auto-download if online and data might be stale
    if(navigator.onLine){
      const lastLogin=saved.fechaLogin||0;
      if(Date.now()-lastLogin>3600000)descargarDatos(); // refresh if >1hr
    }
  } else {
    mostrar('scrLogin');
  }
}

// Register service worker
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(e=>console.log('SW error:',e))}

init();
</script>
</body>
</html>
